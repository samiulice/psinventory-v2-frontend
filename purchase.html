<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PSINVENTORY</title>

  <!-- Bootstrap -->
  <link href="src/assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="src/assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="src/assets/vendors/fontawesome-free-6.6.0-web/css/all.min.css" rel="stylesheet">
  <!-- bootstrap-daterangepicker -->
  <link href="src/assets/vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
  <!-- Custom Theme Style -->
  <link href="src/assets/css/custom.min.css" rel="stylesheet">
  <script src="src/assets/js/app.js"></script>
  <style>
    /* Autocomplete container - NEW */
    .autocomplete-container {
      position: relative;
      display: inline-block;
      width: 100%;
      /* Match parent width */
    }

    /* Suggestion list styling */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      background: #fff;
      top: 100%;
      /* Position below input */
      left: 0;
      margin-top: 2px;
      display: none;
      /* Hidden by default */
    }

    .autocomplete-item {
      padding: 5px 5px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .autocomplete-item:hover {
      background: #D0F1E6;
    }

    .btn-xxs {
      display: inline-block;
      outline: 0;
      cursor: pointer;
      border-radius: 3px;
      border: 1px solid #000000;
      font-size: 10px;
      height: 15px;
      padding: 0 3px;
      text-align: center;
      font-weight: 500;
    }


    .custom-checkbox-wrapper {
      --blue: #0D7EFF;
      --g08: #E1E5EB;
      --g04: #848ea1;
    }

    .custom-checkbox-wrapper .tgl {
      display: none;
    }

    .custom-checkbox-wrapper .tgl,
    .custom-checkbox-wrapper .tgl:after,
    .custom-checkbox-wrapper .tgl:before,
    .custom-checkbox-wrapper .tgl *,
    .custom-checkbox-wrapper .tgl *:after,
    .custom-checkbox-wrapper .tgl *:before,
    .custom-checkbox-wrapper .tgl+.tgl-btn {
      box-sizing: border-box;
    }

    .custom-checkbox-wrapper .tgl::selection,
    .custom-checkbox-wrapper .tgl:after::selection,
    .custom-checkbox-wrapper .tgl:before::selection,
    .custom-checkbox-wrapper .tgl *::selection,
    .custom-checkbox-wrapper .tgl *:after::selection,
    .custom-checkbox-wrapper .tgl *:before::selection,
    .custom-checkbox-wrapper .tgl+.tgl-btn::selection {
      background: none;
    }

    .custom-checkbox-wrapper .tgl+.tgl-btn {
      outline: 0;
      display: block;
      width: 40px;
      height: 18px;
      position: relative;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 400;
      color: #fff;
    }

    .custom-checkbox-wrapper .tgl+.tgl-btn:after,
    .custom-checkbox-wrapper .tgl+.tgl-btn:before {
      position: relative;
      display: block;
      content: "";
      width: 44%;
      height: 100%;
    }

    .custom-checkbox-wrapper .tgl+.tgl-btn:after {
      left: 0;
    }

    .custom-checkbox-wrapper .tgl+.tgl-btn:before {
      display: inline;
      position: absolute;
      top: 3px;
    }

    .custom-checkbox-wrapper .tgl:checked+.tgl-btn:after {
      left: 56.5%;
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn {
      background: var(--g08);
      border-radius: 20rem;
      padding: 2px;
      transition: all 0.4s ease;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn:after {
      border-radius: 2em;
      background: #fff;
      transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), padding 0.3s ease, margin 0.3s ease;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn:before {
      content: "No";
      left: 20px;
      color: var(--g04);
      transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn:active {
      box-shadow: inset 0 0 0 30px rgba(0, 0, 0, 0.1);
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn:active:after {
      padding-right: 0.4em;
    }

    .custom-checkbox-wrapper .tgl-ios:checked+.tgl-btn {
      background: var(--blue);
    }

    .custom-checkbox-wrapper .tgl-ios:checked+.tgl-btn:active {
      box-shadow: inset 0 0 0 30px rgba(0, 0, 0, 0.1);
    }

    .custom-checkbox-wrapper .tgl-ios:checked+.tgl-btn:active:after {
      margin-left: -0.4em;
    }

    .custom-checkbox-wrapper .tgl-ios:checked+.tgl-btn:before {
      content: "Yes";
      left: 4px;
      color: #fff;
    }
  </style>
</head>

<body class="nav-md">
  <div class="container body">
    <div class="main_container">
      <div class="col-md-3 left_col menu_fixed">
        <div class="left_col scroll-view">
          <div class="navbar nav_title" style="border: 0;">
            <a href="index.html" class="site_title"><span>PS INVENTORY</span></a>
          </div>

          <div class="clearfix"></div>

          <!-- menu profile quick info -->
          <div class="profile clearfix">
            <div class="profile_pic">
              <img src="https://psinventory-v2.onrender.com/images/logo.png" alt="..." class="img-circle profile_img">
            </div>
            <div class="profile_info">
              <span>Welcome,</span>
              <h2 id="profile-name"></h2>
            </div>
          </div>
          <!-- /menu profile quick info -->

          <br />
          <!-- sidebar menu -->
          <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
            <div class="menu_section">
              <ul class="nav side-menu">
                <li><a><i class="fa fa-home"></i> Home <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="index.html">Dashboard</a></li>
                  </ul>
                </li>
                <li><a><i class="fa fa-cogs"></i> MIS <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="customer-list.html">Customer List</a></li>
                    <li><a href="supplier-list.html">Supplier List</a></li>
                    <li><a href="employee-list.html">Employee List</a></li>
                  </ul>
                </li>
                <li><a><i class="fa fa-table"></i> Inventory <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="sale.html">Sale</a></li>
                    <li><a href="sale-return.html">Sale Return</a></li>
                    <li><a href="purchase.html">Purchase</a></li>
                    <li><a href="purchase-return.html">Purchase Return</a></li>
                    <li><a href="warranty.html">Warranty</a></li>
                    <li><a href="service.html">Service</a></li>
                    <li><a href="memo-list.html">Memo List</a></li>
                    <li><a href="transaction-posting.html">Transaction Posting</a></li>
                  </ul>
                </li>
                <li><a><i class="fa fa-bar-chart-o"></i> Accounts <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="receive-collection.html">Receive & Collection</a></li>
                    <li><a href="payment.html">Payment</a></li>
                    <li><a href="expenses.html">Expenses</a></li>
                    <li><a href="investment.html">Investment</a></li>
                  </ul>
                </li>
                <li><a><i class="fa fa-file-text"></i>Inventory Reports <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li class="sub_menu"><a href="stock-report.html">Stock Report</a></li>
                    <li class="sub_menu"><a href="stock-alert-report.html">Stock Alert Report</a></li>
                    <li class="sub_menu"><a href="purchase-history.html">Purchase History</a></li>
                    <li class="sub_menu"><a href="sales-history.html">Sales History</a></li>
                    <li class="sub_menu"><a href="product-list.html">Product List</a></li>
                    <li class="sub_menu"><a href="brand-list.html">Brand List</a></li>
                    <li class="sub_menu"><a href="category-list.html">Category List</a></li>
                    <li class="sub_menu"><a href="service-list.html">Service List</a></li>
                  </ul>
                </li>

                <li><a><i class="fa fa-file-text"></i>Accounts Reports <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li class="sub_menu"><a href="transaction-history.html">Transaction History</a></li>
                    <li class="sub_menu"><a href="customer-due-report.html">Customer Due Report</a></li>
                    <li class="sub_menu"><a href="supplier-due-report.html">Supplier Due Report</a></li>
                    <li class="sub_menu"><a href="ledger-book-summary.html">Ledger Book(SUMMARY)</a></li>
                    <li class="sub_menu"><a href="ledger-book-details.html">Ledger Book(DETAILS)</a></li>
                    <li class="sub_menu"><a href="expense-categories.html">Expenses Category</a></li>
                    <li class="sub_menu"><a href="expense-history.html">Expenses History</a></li>
                    <li class="sub_menu"><a href="income-statement.html">Income Statement</a></li>
                    <li class="sub_menu"><a href="top-sheet.html">TOP Sheet</a></li>
                    <li class="sub_menu"><a href="trial-balance.html">Trial Balance</a></li>
                    <li class="sub_menu"><a href="balance-sheet.html">Balance Sheet</a></li>
                  </ul>
                </li>

              </ul>
            </div>
          </div>
          <!-- /sidebar menu -->

          <!-- /menu footer buttons -->
          <div class="sidebar-footer hidden-small">
            <a data-toggle="tooltip" data-placement="top" title="Settings" href="settings.html">
              <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Relaunch" href="index.html">
              <span class="glyphicon glyphicon-home" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Company Info" href="company-info.html">
              <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Logout" onclick="terminateSession()">
              <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
            </a>
          </div>
          <!-- /menu footer buttons -->
        </div>
      </div>



      <!-- page content -->
      <div id="page-content" class="right_col" role="main">
        <!-- Content Title -->
        <h2 class="text-center tale fa-2x">PURCHASE</h2>
        <form id="itemForm">
          <div class="x_panel">
            <div class="x_content">
              <div class="row">
                <div class="col-md-4 col-sm-6 col-xs-12">
                  <!-- Date -->
                  <div class="form-group has-feedback">
                    <label for="purchase_date">Purchase Date * :</label>
                    <input type="text" class="form-control has-feedback-left input-sm" id="purchase_date"
                      placeholder="Select date" required>
                    <i style="color: rgba(0, 0, 0, 1);"
                      class="fa fa-calendar form-control-feedback left input-sm-feedback" aria-hidden="true"></i>
                  </div>
                  <!-- Memo No -->
                  <div class="form-group has-feedback">
                    <div class="row">
                      <div class="col-md-10 col-sm-10 col-xs-10">
                        <label for="memo_no">Memo No :</label>
                        <div id="memo-autocomplete-container" class="autocomplete-container">
                          <input type="text" id="memo_no" class="form-control form-select has-feedback-left input-sm"
                            placeholder="Enter Memo No" autocomplete="off">
                          <i style="color: rgba(0, 0, 0, 1);"
                            class="form-control-feedback left fa fa-list input-sm-feedback" aria-hidden="true">
                          </i>
                          <div id="memo-suggestions" class="autocomplete-items"></div>
                        </div>
                      </div>
                      <div style="margin-top: 24px; margin-right: 5px;" class="pull-right">
                        <button type="button" class="btn btn-sm btn-danger pull-left" id="edit_purchase_btn">
                          <i class="fa fa-edit"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- Supplier Account -->
                  <div class="form-group has-feedback">
                    <div class="row">
                      <div class="col-md-10 col-sm-10 col-xs-10">
                        <label for="supplier">Supplier * :</label>
                        <div id="supplier-autocomplete-container" class="autocomplete-container">
                          <input type="text" id="supplier" class="form-control form-select has-feedback-left input-sm"
                            placeholder="Enter Name/Mobile/Code" autocomplete="off" required>
                          <i style="color: rgba(0, 0, 0, 1);"
                            class="form-control-feedback left fa fa-user input-sm-feedback" aria-hidden="true">
                          </i>
                          <div id="supplier-suggestions" class="autocomplete-items"></div>
                        </div>
                      </div>
                      <div style="margin-top: 24px; margin-right: 5px;" class="pull-right">
                        <button type="button" class="btn btn-sm btn-danger pull-right" id="createSupplierBtn">
                          <i class="fa fa-plus"></i>&nbsp;
                        </button>
                      </div>
                    </div>
                  </div>

                </div>
                <div class="col-md-3 col-sm-6 col-xs-12">
                  <!-- Cash-Bank Account -->
                  <div class="form-group has-feedback">
                    <label for="head_account">Cash-Bank Account * :</label>
                    <select id="head_account" class="form-control form-select has-feedback-left input-sm" required>
                      <option value="" selected disabled>Select Account</option>
                      <!--Updated by JS DOM -->
                    </select>
                    <i style="color: rgba(0, 0, 0, 1);" class="form-control-feedback left fa fa-bank input-sm-feedback"
                      aria-hidden="true">
                    </i>
                  </div>
                  <!-- Challan No -->
                  <div class="form-group has-feedback">
                    <label for="challan_no">Challan No :</label>
                    <input type="text" class="form-control has-feedback-left input-sm" id="challan_no"
                      placeholder="Challan No">
                    <i style="color: rgba(0, 0, 0, 1);"
                      class="fa fa-file-word-o form-control-feedback left input-sm-feedback" aria-hidden="true">
                    </i>
                  </div>
                  <!-- Note -->
                  <div class="form-group has-feedback">
                    <label for="note">Note :</label>
                    <input type="text" class="form-control has-feedback-left input-sm" id="note" placeholder="Note">
                    <i style="color: rgba(0, 0, 0, 1);"
                      class="fa fa-comment form-control-feedback left input-sm-feedback" aria-hidden="true">
                    </i>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12">
                  <div class="form-group has-feedback">
                    <!-- Bill Amount -->
                    <label for="bill_amount">Bill Amount * :</label>
                    <input type="number" min="0" class="form-control has-feedback-left input-sm" id="bill_amount"
                      placeholder="0" readonly>
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-money form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                  </div>
                  <!-- Discount -->
                  <div class="form-group has-feedback">
                    <label for="discount">Discount :</label>
                    <input type="number" step="0.01" min="0" max="100.00" value="0"
                      class="form-control has-feedback-left has-feedback-right input-sm" id="discount" placeholder="%"
                      required>
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-gift form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                    <span style="color: rgba(0, 0, 0, 1); font-weight: bold; border: none;"
                      class="form-control-feedback right input-sm-feedback" aria-hidden="true">%
                    </span>
                  </div>
                  <!-- Shipment Cost -->
                  <div class="form-group has-feedback">
                    <label for="shipment_cost">Shipment Cost * :</label>
                    <input type="number" min="0" value="0" class="form-control has-feedback-left input-sm"
                      id="shipment_cost" placeholder="Shipment Cost" required>
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-money form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                  </div>
                </div>
                <div class="col-md-2 col-sm-6 col-xs-12">
                  <!-- Total amount -->
                  <div class="form-group">
                    <label for="total_amount">Total Amount * :</label>
                    <input type="number" min="0" class="form-control input-sm" id="total_amount"
                      placeholder="Total Amount">

                    </i>
                  </div>
                  <!-- Paid amount -->
                  <div class="form-group">
                    <label for="paid_amount">Paid Amount * :</label>
                    <input type="number" min="0" class="form-control input-sm" id="paid_amount"
                      placeholder="Paid Amount" required>
                  </div>
                  <div class="form-group">
                    <label for="due_amount">Due Amount * :</label>
                    <input type="number" min="0" class="form-control input-sm" id="due_amount" placeholder="Due Amount"
                      readonly>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 col-sm-6 col-xs-12">
              <div class="input-group">
                <div id="product-autocomplete-container" class="autocomplete-container">
                  <input type="text" id="product_item" class="form-control form-select input-sm"
                    placeholder="Enter Product Name/Code" autocomplete="off">
                  <div id="product-suggestions" class="autocomplete-items"></div>
                </div>
                <span class="input-group-btn">
                  <button type="button" class="btn btn-sm btn-dark pull-right" onclick="addRow()"> Add</button>
                </span>
              </div>
            </div>
            <div class="col-md-8 col-sm-6 col-xs-12">
              <div class="pull-right">
                <button type="button" class="btn btn-xs btn-primary" id="createCategoryBtn">
                  <i class="fa fa-plus">&nbsp;&nbsp;</i>Add Category
                </button>
              </div>
              <div class="pull-right">
                <button type="button" class="btn btn-xs btn-primary" id="createBrandBtn"><i
                    class="fa fa-plus">&nbsp;&nbsp;</i>Add Brand
                </button>
              </div>
              <div class="pull-right">
                <button type="button" class="btn btn-xs btn-primary" id="createProductBtn">
                  <i class="fa fa-plus">&nbsp;&nbsp;</i>Create Product
                </button>
              </div>
            </div>
          </div>
          <div
            style="background-color:#fff; overflow-y: scroll; scrollbar-width: thin; scrollbar-color: #4f6969 #f1f1f1; height: 320px;">

            <table id="itemTable" class="table table-sm">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Warranty</th>
                  <th>Quantity</th>
                  <th>Rate</th>
                  <th>Subtotal</th>
                  <th>Serial Numbers</th>
                  <th>No SN</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be dynamically added here -->
              </tbody>
            </table>
          </div>


          <div class="row form-group has-feedback">
            <!-- Submit Button -->
            <div class="col-md-12 col-sm-12 col-xs-12 text-center" style="margin-top: 5px;">
              <button type="button" id="submitBtn" onclick="submitForm()" class="btn btn-danger btn-sm">Complete
                Purchase</button>
              <button type="button" id="printInvoiceBtn" onclick="printPurchaseInvoice()"
                class="d-none btn btn-dark btn-sm"><i class="fa-solid fa-print"></i>&nbsp;&nbsp;Invoice</button>
              <button type="button" id="printChallanBtn" onclick="printPurchaseChallan()"
                class="d-none btn btn-dark btn-sm"><i class="fa-solid fa-print"></i>&nbsp;&nbsp;Challan</button>
            </div>
          </div>
        </form>
        <!-- /page content -->
      </div>

      <!-- jQuery -->
      <script src="src/assets/vendors/jquery/dist/jquery.min.js"></script>
      <!-- Bootstrap -->
      <script src="src/assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
      <!-- DateJS -->
      <script src="src/assets/vendors/DateJS/build/date.js"></script>
      <!-- bootstrap-daterangepicker -->
      <script src="src/assets/vendors/moment/min/moment.min.js"></script>
      <script src="src/assets/vendors/bootstrap-daterangepicker/daterangepicker.js"></script>

      <!-- Custom Theme Scripts -->
      <script src="src/assets/js/custom.js"></script>
      <script src="src/assets/js/app.js"></script>
      <script src="src/assets/js/swal-popup-form.js"></script>
      <script src="src/assets/js/invoice.js"></script>

      <!-- sweetalert2 script -->
      <script src="src/assets/sweetalert2/sweetalert2.all.min.js"></script>
      <!-- JsBarcode Script -->
      <script src="src/assets/vendors/JsBarcode/JsBarcode.all.min.js"></script>

      <script>
        let products = [], memos = [], selectedProductItem = null, selectedProductIndex = 0, selectedMemo = null, selectedSupplier = null, suppliers = [], headAccounts = [], categories = [], brands = [], purchased_product = [], purchase_details = [], InvoiceData, company;
        window.addEventListener("DOMContentLoaded", event => {
          initSingleDatePicker("#purchase_date");
          fetchMemos(document.getElementById('purchase_date').value, 'purchase_history')
          // Show popup form for adding a new supplier
          document.getElementById("createSupplierBtn").addEventListener("click", e => {
            addNewSupplier("purchase", suppliers);
          });
          // Show popup form for adding a new product type
          document.getElementById("createProductBtn").addEventListener("click", e => {
            let flag = addNewProduct("purchase", brands, categories, products);
          });

          // Initialize fetch promises
          const fetchSuppliers = fetch('https://psinventory-v2.onrender.com/admin/mis/supplier/view/active', { method: "post" })
            .then(response => response.json())
            .then(function (responseData) {
              suppliers = responseData.suppliers || [];
            })
            .catch(function (error) {
              console.error('Error fetching suppliers data:', error);
            });

          const fetchHeadAccounts = fetch('https://psinventory-v2.onrender.com/admin/accounts/get-cash-bank-accounts', { method: "post" })
            .then(response => response.json())
            .then(function (responseData) {
              headAccounts = responseData.head_accounts || [];
            })
            .catch(function (error) {
              console.error('Error fetching head accounts data:', error);
            });

          const fetchCategories = fetch('https://psinventory-v2.onrender.com/admin/inventory/category/list/active', { method: "post" })
            .then(response => response.json())
            .then(function (responseData) {
              categories = responseData.categories || [];
            })
            .catch(function (error) {
              console.error('Error fetching categories data:', error);
            });

          const fetchProducts = fetch('https://psinventory-v2.onrender.com/admin/inventory/products/active', { method: "post" })
            .then(response => response.json())
            .then(function (responseData) {
              products = responseData.products || [];
              console.log("Products: ", products);
            })
            .catch(function (error) {
              console.error('Error fetching products data:', error);
            });

          const fetchBrands = fetch('https://psinventory-v2.onrender.com/admin/inventory/brand/list/active', { method: "post" })
            .then(response => response.json())
            .then(function (responseData) {
              brands = responseData.brands || [];
            })
            .catch(function (error) {
              console.error('Error fetching brands data:', error);
            });

          // Wait for all fetch requests to complete
          Promise.all([fetchSuppliers, fetchHeadAccounts, fetchCategories, fetchProducts, fetchBrands])
            .then(() => {
              updateSupplierDiv();   // Update suppliers after fetching
              updateAccountsDiv();   // Update head accounts after fetching
              updateProductsDiv();   // Update products after fetching
            })
            .catch(error => {
              console.error("Error completing all fetch requests:", error);
            });
        });
        //show popup form for adding new product category
        document.getElementById("createCategoryBtn").addEventListener("click", e => {
          addNewCategory("purchase", categories);
        });
        //show popup form for adding new product type
        document.getElementById("createBrandBtn").addEventListener("click", e => {
          addNewBrand("purchase", brands);
        });

        //updateSupplierDiv updates supplier selection options with the fetched data
        function updateSupplierDiv() {
          const container = document.getElementById('supplier-autocomplete-container');
          const input = document.getElementById("supplier");
          const suggestions = document.getElementById("supplier-suggestions");

          // Function to populate suggestions
          function populateSuggestions(filteredSuppliers) {
            suggestions.innerHTML = '';
            if (filteredSuppliers.length === 0) {
              suggestions.innerHTML = `<div class="autocomplete-item">No results found</div>`;
              return;
            }
            filteredSuppliers.forEach(supplier => {
              const div = document.createElement("div");
              div.className = "autocomplete-item";
              div.innerHTML = `
                <div class="d-flex justify-content-between">
                  <span>${supplier.account_name}</span>
                  <small class="text-muted">${supplier.account_code}</small>
                </div>
              `;
              div.onclick = () => {
                input.value = supplier.account_name;
                suggestions.style.display = 'none';
                selectedSupplier = supplier;
              };
              suggestions.appendChild(div);
            });

          }

          input.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            suggestions.style.display = 'block';

            if (!searchTerm) {
              suggestions.style.display = 'none';
              return;
            }

            const filtered = suppliers
              .filter(s =>
                s.account_name.toLowerCase().includes(searchTerm) ||
                s.mobile.includes(searchTerm)
              )
              .slice(0, 15);
            populateSuggestions(filtered);
          });

          // Show all suggestions on first click
          input.addEventListener("focus", function () {
            const filtered = suppliers.slice(0, 15);
            suggestions.style.display = 'block';
            populateSuggestions(filtered);
          });

          // Hide suggestions when clicking outside
          document.addEventListener("click", (e) => {
            if (!container.contains(e.target)) {
              suggestions.style.display = 'none';
            }
          });
        }

        //updateAccountsDiv updates account selection options with the fetched data 
        function updateAccountsDiv() {
          const account = document.getElementById("head_account")
          account.innerHTML = '';
          console.log("Head Account: ", headAccounts)
          if (headAccounts) {
            headAccounts.forEach((ac, i) => {
              account.innerHTML += `<option value=${i}>${ac.account_name}</option>`;
            });
            account.selectedIndex = 0
          } else {
            account.innerHTML = `<option value="" selected disabled>No Account Available</option>`;
          }
        }

        function updateProductsDiv() {
          const container = document.getElementById('product-autocomplete-container');
          const input = document.getElementById("product_item");
          const suggestions = document.getElementById("product-suggestions");

          // Function to populate suggestions
          function populateSuggestions(filteredProducts) {
            suggestions.innerHTML = '';
            if (filteredProducts.length === 0) {
              suggestions.innerHTML = `<div class="autocomplete-item">No results found</div>`;
              return;
            }
            filteredProducts.forEach((item, index) => {
              const div = document.createElement("div");
              div.className = "autocomplete-item";
              div.innerHTML = `
                <div class="d-flex justify-content-between">
                  <span>${item.product_name}</span>
                  <small>${item.product_code}</small>
                </div>
              `;
              div.onclick = () => {
                input.value = item.product_name;
                suggestions.style.display = 'none';
                selectedProductItem = item;
                selectedProductIndex = index;
              };
              suggestions.appendChild(div);
            });
          }

          input.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            suggestions.style.display = 'block';

            if (!searchTerm) {
              suggestions.style.display = 'none';
              return;
            }

            const filtered = products
              .filter(p =>
                p.product_name.toLowerCase().includes(searchTerm) ||
                p.product_code.toLowerCase().includes(searchTerm) ||
                p.category.name.toLowerCase().includes(searchTerm)
              )
              .slice(0, 15);
            populateSuggestions(filtered);
          });

          // Show all suggestions on first click
          input.addEventListener("focus", function () {
            const filtered = products.slice(0, 15);
            suggestions.style.display = 'block';
            populateSuggestions(filtered);
          });

          // Hide suggestions when clicking outside
          document.addEventListener("click", (e) => {
            if (!container.contains(e.target)) {
              suggestions.style.display = 'none';
            }
          });
        }

        function updateMemosDiv() {
          const container = document.getElementById('memo-autocomplete-container');
          const input = document.getElementById("memo_no");
          const editBtn = document.getElementById("edit_purchase_btn");
          const suggestions = document.getElementById("memo-suggestions");
          input.placeholder = 'Enter Memo No'
          input.disabled = false;
          editBtn.disabled = false;
          // Function to populate suggestions
          function populateSuggestions(filteredMemo) {
            suggestions.innerHTML = '';
            if (filteredMemo.length === 0) {
              suggestions.innerHTML = `<div class="autocomplete-item">No results found</div>`;
              input.placeholder = 'No memo found';
              input.disabled = true
              editBtn.disabled = true
              return;
            }
            filteredMemo.forEach((item, index) => {
              const div = document.createElement("div");
              div.className = "autocomplete-item";
              div.innerHTML = `
                <div class="d-flex justify-content-between">
                  <span>${item.voucher_no}</span>
                </div>
              `;
              div.onclick = () => {
                input.value = item.voucher_no;
                suggestions.style.display = 'none';
                selectedMemo = item;
              };
              suggestions.appendChild(div);
            });
          }

          input.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toUpperCase();
            suggestions.style.display = 'block';

            if (!searchTerm) {
              suggestions.style.display = 'none';
              return;
            }

            const filtered = memos
              .filter(m =>
                m.voucher_no.includes(searchTerm)
              )
              .slice(0, 15);
            populateSuggestions(filtered);
          });

          // Show all suggestions on first click
          input.addEventListener("focus", function () {
            const filtered = memos.slice(0, 15);
            suggestions.style.display = 'block';
            populateSuggestions(filtered);
          });

          // Hide suggestions when clicking outside
          document.addEventListener("click", (e) => {
            if (!container.contains(e.target)) {
              suggestions.style.display = 'none';
            }
          });
        }


        // Function to add a new row
        function addRow() {
          const item = selectedProductItem;
          const tableBody = document.querySelector("#itemTable tbody");
          const row = document.createElement("tr");

          checkboxId = moment().format('YYYY-MM-DD_HH-mm-ss-SSS');
          row.innerHTML = `
            <td><input type="text" name="itemName[]" class="form-control input-sm" value='${item.product_name + " #" + selectedProductIndex}' required readonly></td>
            <td><input type="text" name="warranty[]" class="form-control input-sm" value='${item.warranty}' required></td>
            <td><input type="number" name="quantity[]" class="form-control input-sm" min="1" max="100" value="1" onchange="updateRow(this)" required></td>
            <td><input type="number" name="rate[]" class="form-control input-sm" min="0" onchange="updateRow(this)" required></td>
            <td><input type="number" name="subtotal[]" class="form-control input-sm" value="0" readonly></td>
            <td><div class="serial-numbers" style="overflow-y:scroll; max-height:200px;overflow-y: scroll; scrollbar-width: thin; scrollbar-color: #4f6969 #f1f1f1;"></div></td>
            <td>
              <div class="custom-checkbox-wrapper">
                <input type='checkbox' class='tgl tgl-ios no-sn-checkbox' id='toggle-checkbox_${checkboxId}' onclick="toggleSerialNumbers(this)">
                <label class='tgl-btn' for='toggle-checkbox_${checkboxId}'></label>
              </div>
            </td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="fa-solid fa-trash-can"></i></button></td>
          `;

          // Store the product ID in a data attribute of the row
          row.dataset.productId = item.id;
          row.dataset.productIndex = selectedProductIndex;
          tableBody.appendChild(row);
          updateRow(row.querySelector('input[name="quantity[]"]'));
        }

        // Function to update the row (Subtotal and Serial Numbers)
        function updateRow(element) {
          const row = element.closest("tr");
          const quantity = parseInt(row.querySelector('input[name="quantity[]"]').value, 10) || 0;
          const rate = parseFloat(row.querySelector('input[name="rate[]"]').value) || 0;
          const subtotalField = row.querySelector('input[name="subtotal[]"]');
          const serialNumbersContainer = row.querySelector('.serial-numbers');
          let noSnCheckbox = row.querySelector('.no-sn-checkbox');
          noSnCheckbox.readOnly = true;
          let currentProduct = products[row.dataset.productIndex];

          if (currentProduct.warranty === 0) {
            noSnCheckbox.checked = true;
          }
          // Update subtotal
          const subtotal = Math.round(quantity * rate);
          subtotalField.value = subtotal;
          updateTotal();

          if (!noSnCheckbox.checked) {
            const existingSerials = Array.from(serialNumbersContainer.querySelectorAll('input[type="text"]'))
              .map((input) => input.value);

            serialNumbersContainer.innerHTML = '';

            for (let i = 0; i < quantity; i++) {
              const serialWrapper = document.createElement("div");
              serialWrapper.classList.add("input-group");

              const serialInput = document.createElement("input");
              serialInput.type = "text";
              serialInput.required = true;
              serialInput.name = `serialNumber[${quantity - 1}][]`;
              serialInput.placeholder = `Serial ${i + 1}`;
              serialInput.classList.add("form-control", "input-sm");
              serialInput.value = existingSerials[i] || '';

              // --- New: Focus management logic ---
              // 1. Handle Enter/Tab key from barcode scanner
              serialInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === 'Tab') {
                  e.preventDefault();
                  const allSerials = serialNumbersContainer.querySelectorAll('input[type="text"]');
                  const currentIndex = Array.from(allSerials).indexOf(this);

                  if (currentIndex < allSerials.length - 1) {
                    allSerials[currentIndex + 1].focus(); // Next serial field
                  } else {
                    // Move to next logical field (e.g., rate input)
                    row.querySelector('input[name="rate[]"]').focus();
                  }
                }
              });

              // Rest of your existing serial input setup
              const removeBtn = document.createElement("button");
              removeBtn.type = "button";
              removeBtn.classList.add("btn", "btn-danger", "btn-sm");
              removeBtn.innerHTML = `<i class="fa-solid fa-xmark"></i>`;
              removeBtn.onclick = () => removeSerialNumber(serialWrapper, row);

              const span = document.createElement("span");
              span.classList.add("input-group-btn");
              span.appendChild(removeBtn);

              serialWrapper.appendChild(serialInput);
              serialWrapper.appendChild(span);
              serialNumbersContainer.appendChild(serialWrapper);
            }
          } else {
            serialNumbersContainer.innerHTML = '';
          }
        }
        // Function to remove a serial number and update quantity and subtotal
        function removeSerialNumber(serialInput, row) {
          const serialWrapper = serialInput.closest("div");
          serialWrapper.remove();

          // Update quantity and subtotal
          const quantityField = row.querySelector('input[name="quantity[]"]');
          let quantity = parseInt(quantityField.value);
          quantity -= 1;
          if (quantity < 0) quantity = 0;
          quantityField.value = quantity;

          // Recalculate subtotal
          const rate = row.querySelector('input[name="rate[]"]').value;
          const subtotalField = row.querySelector('input[name="subtotal[]"]');
          const subtotal = Math.round(quantity * rate);
          subtotalField.value = subtotal;
          updateTotal();
        }

        // Function to update the total subtotal in the footer
        function updateTotal() {
          let billAmount = 0, discountAmount = 0, totalAmount = 0;
          document.querySelectorAll('input[name="subtotal[]"]').forEach(subtotalField => {
            billAmount += parseInt(parseFloat(subtotalField.value) || 0); // Convert subtotal to integer
          });
          document.getElementById("bill_amount").value = billAmount;
          discountAmount = parseFloat(document.getElementById("discount").value) || 0;
          totalAmount = Math.round(billAmount - billAmount * discountAmount / 100)
          document.getElementById("total_amount").value = totalAmount;
          document.getElementById("paid_amount").max = totalAmount;
          document.getElementById("due_amount").value = totalAmount - parseInt(document.getElementById("paid_amount").value) || 0;
        }
        //updating total amount on change discount input
        document.getElementById("discount").addEventListener("change", e => {
          let billAmount = parseInt(document.getElementById("bill_amount").value) || 0;
          let discountAmount = parseFloat(document.getElementById("discount").value) || 0;
          let totalAmount = Math.round(billAmount - billAmount * discountAmount / 100)
          document.getElementById("total_amount").value = totalAmount;
          document.getElementById("paid_amount").max = totalAmount;
          document.getElementById("due_amount").value = totalAmount - parseInt(document.getElementById("paid_amount").value) || 0;
        })
        //updating discount on change total_amount input
        document.getElementById("total_amount").addEventListener("change", e => {
          let totalAmount = parseInt(document.getElementById("total_amount").value) || 0;
          let billAmount = parseInt(document.getElementById("bill_amount").value) || 0;
          document.getElementById("discount").value = parseFloat((billAmount - totalAmount) * 100 / billAmount).toFixed(2);
          document.getElementById("paid_amount").max = totalAmount
          document.getElementById("due_amount").value = totalAmount - parseInt(document.getElementById("paid_amount").value) || 0;
        })
        //updating due amount on change paid_amount input
        document.getElementById("paid_amount").addEventListener("change", e => {
          let totalAmount = parseInt(document.getElementById("total_amount").value) || 0
          let paidAmount = parseInt(document.getElementById("paid_amount").value) || 0
          document.getElementById("due_amount").value = totalAmount - paidAmount;
        })

        // Function to remove a row
        function removeRow(button) {
          const row = button.closest("tr");
          row.remove();
          updateTotal();
        }

        // Function to toggle serial numbers based on "No SN" checkbox
        function toggleSerialNumbers(checkbox) {
          const row = checkbox.closest("tr");
          updateRow(row.querySelector('input[name="quantity[]"]')); // Update row when toggling
        }

        // Function to get all table data including serial numbers
        function getTableData() {
          const tableBody = document.querySelector("#itemTable tbody");
          const rows = tableBody.querySelectorAll("tr");
          const data = [];

          rows.forEach(row => {
            const product_name = row.querySelector('input[name="itemName[]"]').value;
            const warranty = parseInt(row.querySelector('input[name="warranty[]"]').value);
            const quantity = parseInt(row.querySelector('input[name="quantity[]"]').value);
            const rate = parseInt(row.querySelector('input[name="rate[]"]').value);
            const subtotal = parseInt(row.querySelector('input[name="subtotal[]"]').value);
            const serial_numbers = Array.from(row.querySelectorAll('input[name^="serialNumber"]')).map(input => input.value);
            const no_serial_number = row.querySelector('.no-sn-checkbox').checked;

            const parts = product_name.split("#");
            let item = products[parseInt(parts[parts.length - 1])]
            data.push({
              item,
              warranty,
              quantity,
              rate,
              subtotal,
              serial_numbers,
              no_serial_number
            });
          });

          return data;
        }

        //update purchase form section start

        document.getElementById("purchase_date").addEventListener("blur", event => {
          memos = []
          fetchMemos(document.getElementById('purchase_date').value, 'purchase_history')
        })

        // Function to fetch data from the backend
        function fetchMemos(date, postingType) {
          const payload = {
            date: date,
            posting_type: postingType
          };

          const requestOptions = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          };
          fetch('https://psinventory-v2.onrender.com/admin/inventory/transaction/get-list', requestOptions)
            .then(response => response.json())
            .then(data => {
              console.log(data.result)
              if (data.error === true) {
                showErrorMessage(data.message)
              } else {
                memos = data.result || []; // Return the fetched data
                memos = memos.filter(m => !m.data_lock)
                updateMemosDiv()
              }
            });
        }


        //update purchase form section end

        //submit form 
        function submitForm() {
          const form = document.getElementById("itemForm")
          // Prevent actual form submission
          if (!form.checkValidity()) {
            alertQuestion("Please fill out the required fields.");
            return;
          }

          const tableData = getTableData();
          //disable submit btn
          document.getElementById("submitBtn").innerHTML = 'Processing &nbsp;<i class="fa fa-spinner fa-spin"></i>';
          document.getElementById("submitBtn").disabled = true;

          const reqBody = {
            purchase_date: document.getElementById("purchase_date").value,
            supplier: selectedSupplier,
            head_account: headAccounts[parseInt(document.getElementById("head_account").value)],
            memo_no: document.getElementById("memo_no").value,
            challan_no: document.getElementById("challan_no").value,
            note: document.getElementById("note").value,
            bill_amount: parseInt(document.getElementById("bill_amount").value),
            discount: parseFloat(document.getElementById("discount").value),
            shipment_cost: parseInt(document.getElementById("shipment_cost").value),
            total_amount: parseInt(document.getElementById("total_amount").value),
            paid_amount: parseInt(document.getElementById("paid_amount").value),
            due_amount: parseInt(document.getElementById("due_amount").value),
            purchased_product: tableData
          }
          console.log(reqBody); // Log table data to console
          const requestOptions = {
            method: 'post',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(reqBody),
          }
          fetch('https://psinventory-v2.onrender.com/admin/inventory/products/purchase', requestOptions)
            .then(response => response.json())
            .then(data => {
              console.log("purchase response:", data)
              if (data.error === true) {
                showErrorMessage(data.message)
              } else {
                showSuccessMessage(data.message);
                company = data.company;
                InvoiceData = data.invoice_data;
                //reset submit btn
                setTimeout(() => {
                  document.getElementById("submitBtn").classList.add('d-none');
                  document.getElementById("printInvoiceBtn").classList.remove('d-none')
                document.getElementById("printChallanBtn").classList.remove('d-none')
                }, 1000);
                
              }
            });
        }
        
      </script>
</body>

</html>