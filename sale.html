<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PSINVENTORY</title>

  <!-- Bootstrap -->
  <link href="src/assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="src/assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="src/assets/vendors/fontawesome-free-6.6.0-web/css/all.min.css" rel="stylesheet">
  <!-- bootstrap-daterangepicker -->
  <link href="src/assets/vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
  <!-- Custom Theme Style -->
  <link href="src/assets/css/custom.min.css" rel="stylesheet">
  <script src="src/assets/js/app.js"></script>
  <style>
    /* Autocomplete container - NEW */
    .autocomplete-container {
      position: relative;
      display: inline-block;
      width: 100%;
      /* Match parent width */
    }

    /* Suggestion list styling */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      background: #fff;
      top: 100%;
      left: 0;
      margin-top: 2px;
      display: none;
    }

    .autocomplete-item {
      padding: 5px 5px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .autocomplete-item:hover {
      background: #D0F1E6;
    }
  </style>
  <style>
    .btn-xxs {
      display: inline-block;
      outline: 0;
      cursor: pointer;
      border-radius: 3px;
      border: 1px solid #000000;
      font-size: 10px;
      height: 15px;
      padding: 0 3px;
      text-align: center;
      font-weight: 500;
    }

    input:disabled,
    input:read-only {
      background-color: #e8fbfe !important
    }


    .custom-checkbox-wrapper {
      --blue: #0D7EFF;
      --g08: #E1E5EB;
      --g04: #848ea1;
    }

    .custom-checkbox-wrapper .tgl {
      display: none;
    }

    .custom-checkbox-wrapper .tgl,
    .custom-checkbox-wrapper .tgl:after,
    .custom-checkbox-wrapper .tgl:before,
    .custom-checkbox-wrapper .tgl *,
    .custom-checkbox-wrapper .tgl *:after,
    .custom-checkbox-wrapper .tgl *:before,
    .custom-checkbox-wrapper .tgl+.tgl-btn {
      box-sizing: border-box;
    }

    .custom-checkbox-wrapper .tgl::selection,
    .custom-checkbox-wrapper .tgl:after::selection,
    .custom-checkbox-wrapper .tgl:before::selection,
    .custom-checkbox-wrapper .tgl *::selection,
    .custom-checkbox-wrapper .tgl *:after::selection,
    .custom-checkbox-wrapper .tgl *:before::selection,
    .custom-checkbox-wrapper .tgl+.tgl-btn::selection {
      background: none;
    }

    .custom-checkbox-wrapper .tgl+.tgl-btn {
      outline: 0;
      display: block;
      width: 40px;
      height: 18px;
      position: relative;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 400;
      color: #fff;
    }

    .custom-checkbox-wrapper .tgl+.tgl-btn:after,
    .custom-checkbox-wrapper .tgl+.tgl-btn:before {
      position: relative;
      display: block;
      content: "";
      width: 44%;
      height: 100%;
    }

    .custom-checkbox-wrapper .tgl+.tgl-btn:after {
      left: 0;
    }

    .custom-checkbox-wrapper .tgl+.tgl-btn:before {
      display: inline;
      position: absolute;
      top: 3px;
    }

    .custom-checkbox-wrapper .tgl:checked+.tgl-btn:after {
      left: 56.5%;
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn {
      background: var(--g08);
      border-radius: 20rem;
      padding: 2px;
      transition: all 0.4s ease;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn:after {
      border-radius: 2em;
      background: #fff;
      transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), padding 0.3s ease, margin 0.3s ease;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn:before {
      content: "No";
      left: 20px;
      color: var(--g04);
      transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn:active {
      box-shadow: inset 0 0 0 30px rgba(0, 0, 0, 0.1);
    }

    .custom-checkbox-wrapper .tgl-ios+.tgl-btn:active:after {
      padding-right: 0.4em;
    }

    .custom-checkbox-wrapper .tgl-ios:checked+.tgl-btn {
      background: var(--blue);
    }

    .custom-checkbox-wrapper .tgl-ios:checked+.tgl-btn:active {
      box-shadow: inset 0 0 0 30px rgba(0, 0, 0, 0.1);
    }

    .custom-checkbox-wrapper .tgl-ios:checked+.tgl-btn:active:after {
      margin-left: -0.4em;
    }

    .custom-checkbox-wrapper .tgl-ios:checked+.tgl-btn:before {
      content: "Yes";
      left: 4px;
      color: #fff;
    }
  </style>
</head>

<body class="nav-md">
  <div class="container body">
    <div class="main_container">
      <div class="col-md-3 left_col menu_fixed">
        <div class="left_col scroll-view">
          <div class="navbar nav_title" style="border: 0;">
            <a href="index.html" class="site_title"><span>PS INVENTORY</span></a>
          </div>

          <div class="clearfix"></div>

          <!-- menu profile quick info -->
          <div class="profile clearfix">
            <div class="profile_pic">
              <img src="https://psinventory-v2.onrender.com/images/logo.png" alt="..." class="img-circle profile_img">
            </div>
            <div class="profile_info">
              <span>Welcome,</span>
              <h2 id="profile-name"></h2>
            </div>
          </div>
          <!-- /menu profile quick info -->

          <br />
          <!-- sidebar menu -->
          <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
            <div class="menu_section">
              <ul class="nav side-menu">
                <li><a><i class="fa fa-home"></i> Home <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="index.html">Dashboard</a></li>
                  </ul>
                </li>
                <li><a><i class="fa fa-cogs"></i> MIS <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="customer-list.html">Customer List</a></li>
                    <li><a href="supplier-list.html">Supplier List</a></li>
                    <li><a href="employee-list.html">Employee List</a></li>
                  </ul>
                </li>
                <li><a><i class="fa fa-table"></i> Inventory <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="sale.html">Sale</a></li>
                    <li><a href="sale-return.html">Sale Return</a></li>
                    <li><a href="purchase.html">Purchase</a></li>
                    <li><a href="purchase-return.html">Purchase Return</a></li>
                    <li><a href="warranty.html">Warranty</a></li>
                    <li><a href="service.html">Service</a></li>
                    <li><a href="memo-list.html">Memo List</a></li>
                    <li><a href="transaction-posting.html">Transaction Posting</a></li>
                  </ul>
                </li>
                <li><a><i class="fa fa-bar-chart-o"></i> Accounts <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li><a href="receive-collection.html">Receive & Collection</a></li>
                    <li><a href="payment.html">Payment</a></li>
                    <li><a href="expenses.html">Expenses</a></li>
                    <li><a href="investment.html">Investment</a></li>
                  </ul>
                </li>
                <li><a><i class="fa fa-file-text"></i>Inventory Reports <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li class="sub_menu"><a href="stock-report.html">Stock Report</a></li>
                    <li class="sub_menu"><a href="stock-alert-report.html">Stock Alert Report</a></li>
                    <li class="sub_menu"><a href="purchase-history.html">Purchase History</a></li>
                    <li class="sub_menu"><a href="sales-history.html">Sales History</a></li>
                    <li class="sub_menu"><a href="product-list.html">Product List</a></li>
                    <li class="sub_menu"><a href="brand-list.html">Brand List</a></li>
                    <li class="sub_menu"><a href="category-list.html">Category List</a></li>
                    <li class="sub_menu"><a href="service-list.html">Service List</a></li>
                  </ul>
                </li>

                <li><a><i class="fa fa-file-text"></i>Accounts Reports <span class="fa fa-chevron-down"></span></a>
                  <ul class="nav child_menu">
                    <li class="sub_menu"><a href="transaction-history.html">Transaction History</a></li>
                    <li class="sub_menu"><a href="customer-due-report.html">Customer Due Report</a></li>
                    <li class="sub_menu"><a href="supplier-due-report.html">Supplier Due Report</a></li>
                    <li class="sub_menu"><a href="ledger-book-summary.html">Ledger Book(SUMMARY)</a></li>
                    <li class="sub_menu"><a href="ledger-book-details.html">Ledger Book(DETAILS)</a></li>
                    <li class="sub_menu"><a href="expense-categories.html">Expenses Category</a></li>
                    <li class="sub_menu"><a href="expense-history.html">Expenses History</a></li>
                    <li class="sub_menu"><a href="income-statement.html">Income Statement</a></li>
                    <li class="sub_menu"><a href="top-sheet.html">TOP Sheet</a></li>
                    <li class="sub_menu"><a href="trial-balance.html">Trial Balance</a></li>
                    <li class="sub_menu"><a href="balance-sheet.html">Balance Sheet</a></li>
                  </ul>
                </li>

              </ul>
            </div>
          </div>
          <!-- /sidebar menu -->

          <!-- /menu footer buttons -->
          <div class="sidebar-footer hidden-small">
            <a data-toggle="tooltip" data-placement="top" title="Settings" href="settings.html">
              <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Relaunch" href="index.html">
              <span class="glyphicon glyphicon-home" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Company Info" href="company-info.html">
              <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Logout" onclick="terminateSession()">
              <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
            </a>
          </div>
          <!-- /menu footer buttons -->
        </div>
      </div>



      <!-- page content -->
      <div id="page-content" class="right_col" role="main">
        <!-- Content Title -->
        <h2 class="text-center tale fa-2x">SALE</h2>
        <form id="itemForm">
          <div class="x_panel">
            <div class="x_content">
              <div class="row">
                <div class="col-md-4 col-sm-6 col-xs-12">
                  <div class="row">
                    <!-- Date -->
                    <div class="form-group has-feedback">
                      <label for="sale_date">Sale Date * :</label>
                      <input type="text" class="form-control has-feedback-left input-sm" id="sale_date"
                        placeholder="Select date" required>
                      <i style="color: rgba(0, 0, 0, 1);"
                        class="fa fa-calendar form-control-feedback left input-sm-feedback" aria-hidden="true"></i>
                    </div>
                    <!-- Cash-Bank Account -->
                    <div class="form-group has-feedback">
                      <label for="head_account">Cash-Bank Account * :</label>
                      <select id="head_account" class="form-control form-select has-feedback-left input-sm" required>
                        <option value="" selected disabled>Select Account</option>
                        <!--Updated by JS DOM -->
                      </select>
                      <i style="color: rgba(0, 0, 0, 1);"
                        class="form-control-feedback left fa fa-bank input-sm-feedback" aria-hidden="true">
                      </i>
                    </div>
                    <!-- Customer Account -->
                    <div class="form-group has-feedback">
                      <div class="row">
                        <div class="col-md-10 col-sm-8 col-xs-8">
                          <label for="customer">Customer * :</label>
                          <div id="customer-autocomplete-container" class="autocomplete-container">
                            <input type="text" id="customer" class="form-control form-select has-feedback-left input-sm"
                              placeholder="Enter Name/Mobile/Code" autocomplete="off" required>
                            <i style="color: rgba(0, 0, 0, 1);"
                              class="form-control-feedback left fa fa-user input-sm-feedback" aria-hidden="true">
                            </i>
                            <div id="customer-suggestions" class="autocomplete-items"></div>
                          </div>
                        </div>
                        <div style="margin-top: 24px;">
                          <button type="button" class="btn btn-sm btn-danger pull-left" id="createCustomerBtn">
                            <i class="fa fa-plus"></i>&nbsp;
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-2 col-sm-6 col-xs-12">
                  <!-- Memo No -->
                  <div class="form-group has-feedback">
                    <label for="memo_no">Memo No :</label>
                    <input type="text" class="form-control has-feedback-left input-sm" id="memo_no"
                      placeholder="Memo No">
                    <i style="color: rgba(0, 0, 0, 1);"
                      class="fa fa-file-word-o form-control-feedback left input-sm-feedback" aria-hidden="true">
                    </i>
                  </div>
                  <!-- Challan No -->
                  <div class="form-group has-feedback">
                    <label for="challan_no">Challan No :</label>
                    <input type="text" class="form-control has-feedback-left input-sm" id="challan_no"
                      placeholder="Challan No">
                    <i style="color: rgba(0, 0, 0, 1);"
                      class="fa fa-file-word-o form-control-feedback left input-sm-feedback" aria-hidden="true">
                    </i>
                  </div>
                  <!-- Note -->
                  <div class="form-group has-feedback">
                    <label for="note">Note :</label>
                    <input type="text" class="form-control has-feedback-left input-sm" id="note" placeholder="Note">
                    <i style="color: rgba(0, 0, 0, 1);"
                      class="fa fa-comment form-control-feedback left input-sm-feedback" aria-hidden="true">
                    </i>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12">
                  <div class="form-group has-feedback">
                    <!-- Bill Amount -->
                    <label for="bill_amount">Bill Amount * :</label>
                    <input type="number" min="0" class="form-control has-feedback-left input-sm" id="bill_amount"
                      placeholder="0" readonly>
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-money form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                  </div>
                  <!-- Discount -->
                  <div class="form-group has-feedback">
                    <label for="discount">Discount :</label>
                    <input type="number" step="0.01" min="0" max="100.00" value="0"
                      class="form-control has-feedback-left has-feedback-right input-sm" id="discount" placeholder="%"
                      required>
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-gift form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                    <span style="color: rgba(0, 0, 0, 1); font-weight: bold; border: none;"
                      class="form-control-feedback right input-sm-feedback" aria-hidden="true">%
                    </span>
                  </div>
                  <!-- Shipment Cost -->
                  <div class="form-group has-feedback">
                    <label for="shipment_cost">Shipment Cost * :</label>
                    <input type="number" min="0" value="0" class="form-control has-feedback-left input-sm"
                      id="shipment_cost" placeholder="Shipment Cost" required>
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-money form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                  </div>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-12">
                  <!-- Total amount -->
                  <div class="form-group has-feedback">
                    <label for="total_amount">Total Amount * :</label>
                    <input type="number" min="0" class="form-control has-feedback-left input-sm" id="total_amount"
                      placeholder="Total Amount">
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-money form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                  </div>
                  <!-- Paid amount -->
                  <div class="form-group has-feedback">
                    <label for="paid_amount">Paid Amount * :</label>
                    <input type="number" min="0" max="0" class="form-control has-feedback-left input-sm"
                      id="paid_amount" placeholder="Paid Amount" required>
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-money form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                  </div>
                  <div class="form-group has-feedback">
                    <label for="due_amount">Due Amount * :</label>
                    <input type="number" min="0" class="form-control has-feedback-left input-sm" id="due_amount"
                      placeholder="Due Amount" readonly>
                    <i style="color: rgba(0, 0, 0, 1);" class="fa fa-money form-control-feedback left input-sm-feedback"
                      aria-hidden="true">
                    </i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 col-sm-6 col-xs-12">
              <div class="input-group">
                <div id="product-autocomplete-container" class="autocomplete-container">
                  <input type="text" id="product_item" class="form-control form-select input-sm"
                    placeholder="Enter Product Name/Code" autocomplete="off">
                  <div id="product-suggestions" class="autocomplete-items"></div>
                </div>
                <span class="input-group-btn">
                  <button type="button" class="btn btn-sm btn-dark pull-right" onclick="addRow()"> Add</button>
                </span>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 col-xs-12">
              <div class="pull-right" style="margin-right: 20px;">
                <span
                  style="padding:3px 8px; font-size:14px;  color:#0c0b0b; background:#e9f8eb; border-radius:4px; margin:2px; border:1px solid #daf3e1; white-space:nowrap;">stock:
                  <span id="stock">0</span></span>
                <a style="padding:3px 8px; font-size:14px;  color:#0c0b0b; background:#e9f8eb; border-radius:4px; margin:2px; border:1px solid #daf3e1; white-space:nowrap;"
                  id="togglePriceVisibilityBtn" onclick="togglePriceVisibility()"><i class="fa-solid fa-info"></i></a>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 col-xs-12">
              <div class="pull-right" style="margin-right: 20px;">
                <button type="button" id="submitBtn" onclick="submitForm()" class="btn btn-danger btn-sm">Complete
                  Sale</button>
                <button type="button" id="printInvoiceBtn" class="d-none btn btn-dark btn-sm"
                  onclick="printSaleInvoice()"><i class="fa-solid fa-print"></i>&nbsp;&nbsp;Invoice</button>
                <button type="button" id="printChallanBtn" class="d-none btn btn-dark btn-sm"
                  onclick="printSaleChallan()"><i class="fa-solid fa-print"></i>&nbsp;&nbsp;Challan</button>
              </div>
            </div>
          </div>
          <div
            style="background-color:#fff; overflow-y: scroll; scrollbar-width: thin; scrollbar-color: #4f6969 #f1f1f1;">

            <table id="itemTable" class="table table-sm">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Warranty</th>
                  <th>Quantity</th>
                  <th>Rate</th>
                  <th>Subtotal</th>
                  <th>Serial Numbers</th>
                  <th>No SN</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be dynamically added here -->
              </tbody>
            </table>
          </div>
        </form>
        <!-- /page content -->
      </div>

      <!-- jQuery -->
      <script src="src/assets/vendors/jquery/dist/jquery.min.js"></script>
      <!-- Bootstrap -->
      <script src="src/assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
      <!-- DateJS -->
      <script src="src/assets/vendors/DateJS/build/date.js"></script>
      <!-- bootstrap-daterangepicker -->
      <script src="src/assets/vendors/moment/min/moment.min.js"></script>
      <script src="src/assets/vendors/bootstrap-daterangepicker/daterangepicker.js"></script>

      <!-- Custom Theme Scripts -->
      <script src="src/assets/js/custom.js"></script>
      <script src="src/assets/js/app.js"></script>
      <script src="src/assets/js/swal-popup-form.js"></script>
      <script src="src/assets/js/invoice.js"></script>

      <!-- sweetalert2 script -->
      <script src="src/assets/sweetalert2/sweetalert2.all.min.js"></script>

      <script>
        let selectedCustomer = null, selectedProductItem = null, selectedProductIndex = null, products = [], SerialNumbers = [], customers = [], headAccounts = [], categories = [], brands = [], sold_product = [], sale_details = [], note = "", InvoiceData, company;
        window.addEventListener("DOMContentLoaded", event => {
          initSingleDatePicker("#sale_date");

          // DEBUG 
          // document.getElementById("printInvoiceBtn").classList.remove('d-none')

          document.getElementById("createCustomerBtn").addEventListener("click", e => {
            addNewCustomer("sale", customers);
          });

          // Initialize promises for fetch requests
          const requestOptions = {
            method: "POST",
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': 'Bearer '+localStorage.getItem("token")
            }
          };
          const fetchCustomers = fetch(api+'/api/v2/mis/customer/view/active', requestOptions)
            .then(response => response.json())
            .then(function (responseData) {
              customers = responseData.customers || [];
              company = responseData.company;
            })
            .catch(function (error) {
              console.error('Error fetching customers data:', error);
            });

          const fetchHeadAccounts = fetch(api+'/api/v2/accounts/get-cash-bank-accounts', requestOptions)
            .then(response => response.json())
            .then(function (responseData) {
              headAccounts = responseData.head_accounts || [];
            })
            .catch(function (error) {
              console.error('Error fetching head_accounts data:', error);
            });

          const fetchCategories = fetch(api+'/api/v2/inventory/category/list/active', requestOptions)
            .then(response => response.json())
            .then(function (responseData) {
              categories = responseData.categories || [];
            })
            .catch(function (error) {
              console.error('Error fetching categories data:', error);
            });

          const fetchProducts = fetch(api+'/api/v2/inventory/products/available', requestOptions)
            .then(response => response.json())
            .then(function (responseData) {
              products = responseData.products || [];
              console.log(products)
            })
            .catch(function (error) {
              console.error('Error fetching products data:', error);
            });

          const fetchBrands = fetch(api+'/api/v2/inventory/brand/list/active', requestOptions)
            .then(response => response.json())
            .then(function (responseData) {
              brands = responseData.brands || [];
            })
            .catch(function (error) {
              console.error('Error fetching brands data:', error);
            });

          // Wait for all fetch calls to complete
          Promise.all([fetchCustomers, fetchHeadAccounts, fetchCategories, fetchProducts, fetchBrands])
            .then(() => {
              console.log("All fetch requests completed.");
              updateAccountsDiv()
              updateCustomerDiv()
              updateProductsDiv()
            })
            .catch(error => {
              console.error("Error completing all fetch requests:", error);
            });
        });

        //updateCustomerDiv updates customer selection options with the fetched data
        function updateCustomerDiv() {
          const container = document.getElementById('customer-autocomplete-container');
          const input = document.getElementById("customer");
          const suggestions = document.getElementById("customer-suggestions");

          // Function to populate suggestions
          function populateSuggestions(filteredCustomers) {
            suggestions.innerHTML = '';
            if (filteredCustomers.length === 0) {
              suggestions.innerHTML = `<div class="autocomplete-item">No results found</div>`;
              return;
            }
            filteredCustomers.forEach(customer => {
              const div = document.createElement("div");
              div.className = "autocomplete-item";
              div.innerHTML = `
                <div class="d-flex justify-content-between">
                  <span>${customer.account_name}</span>
                  <small class="text-muted">${customer.account_code}</small>
                </div>
              `;
              div.onclick = () => {
                input.value = customer.account_name;
                suggestions.style.display = 'none';
                selectedCustomer = customer;
              };
              suggestions.appendChild(div);
            });

          }

          input.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            suggestions.style.display = 'block';

            if (!searchTerm) {
              suggestions.style.display = 'none';
              return;
            }

            const filtered = customers
              .filter(c =>
                c.account_name.toLowerCase().includes(searchTerm) ||
                c.mobile.includes(searchTerm)
              )
              .slice(0, 15);
            populateSuggestions(filtered);
          });

          // Show all suggestions on first click
          input.addEventListener("focus", function () {
            const filtered = customers.slice(0, 15);
            suggestions.style.display = 'block';
            populateSuggestions(filtered);
          });

          // Hide suggestions when clicking outside
          document.addEventListener("click", (e) => {
            if (!container.contains(e.target)) {
              suggestions.style.display = 'none';
            }
          });
        }
        
        //updateAccountsDiv updates account selection options with the fetched data 
        function updateAccountsDiv() {
          const account = document.getElementById("head_account")
          account.innerHTML = '';

          if (headAccounts) {
            headAccounts.forEach((ac, i) => {
              account.innerHTML += `<option value=${i}>${ac.account_name}</option>`;
            });
            account.selectedIndex = 0
          } else {
            account.innerHTML = `<option value="" selected disabled>No Account Available</option>`;
          }
        }

        function updateProductsDiv() {
          const container = document.getElementById('product-autocomplete-container');
          const input = document.getElementById("product_item");
          const suggestions = document.getElementById("product-suggestions");

          // Function to populate suggestions
          function populateSuggestions(filteredProducts) {
            suggestions.innerHTML = '';
            if (filteredProducts.length === 0) {
              suggestions.innerHTML = `<div class="autocomplete-item">No results found</div>`;
              return;
            }
            filteredProducts.forEach((item, index) => {
              const div = document.createElement("div");
              div.className = "autocomplete-item";
              div.innerHTML = `
                <div class="d-flex justify-content-between">
                  <span>${item.product_name}</span>
                  <small>${item.product_code}</small>
                </div>
              `;
              div.onclick = () => {
                input.value = item.product_name;
                suggestions.style.display = 'none';
                selectedProductItem = item;
                selectedProductIndex = index;
                document.getElementById("stock").innerText = item.quantity_purchased - item.quantity_sold;
              };
              suggestions.appendChild(div);
            });
          }

          input.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            suggestions.style.display = 'block';

            if (!searchTerm) {
              suggestions.style.display = 'none';
              return;
            }

            const filtered = products
              .filter(c =>
                c.product_name.toLowerCase().includes(searchTerm) ||
                c.product_code.toLowerCase().includes(searchTerm)
              )
              .slice(0, 15);
            populateSuggestions(filtered);
          });

          // Show all suggestions on first click
          input.addEventListener("focus", function () {
            const filtered = products.slice(0, 15);
            suggestions.style.display = 'block';
            populateSuggestions(filtered);
          });

          // Hide suggestions when clicking outside
          document.addEventListener("click", (e) => {
            if (!container.contains(e.target)) {
              suggestions.style.display = 'none';
            }
          });
        }

        //updating quantity available section
        document.getElementById("product_item").addEventListener("change", e => {
          let item = selectedProductItem
          document.getElementById("stock").innerText = item.quantity_purchased - item.quantity_sold;
        })

        //togglePriceVisibility toggle MRP section between visible and hidden state
        function togglePriceVisibility() {
          let btn = document.getElementById("togglePriceVisibilityBtn")
          let item = selectedProductItem
          if (btn.innerHTML === `<i class="fa-solid fa-info"></i>`) {
            btn.innerHTML = Math.round((item.purchase_cost - item.purchase_discount) / item.quantity_purchased);
          } else {
            btn.innerHTML = `<i class="fa-solid fa-info"></i>`
          }
        }

        // Function to add a new row
        function addRow() {
          const item = selectedProductItem
          const tableBody = document.querySelector("#itemTable tbody");
          const row = document.createElement("tr");

          checkboxId = moment().format('YYYY-MM-DD_HH-mm-ss-SSS');
          row.innerHTML = `
              <td><input type="text" name="itemName[]" class="form-control input-sm" value='${item.product_name + " #" + selectedProductIndex}' required readonly></td>
              <td><input type="text" name="warranty[]" class="form-control input-sm" value='${item.warranty}' required></td>
              <td><input type="number" name="quantity[]" class="form-control input-sm" min="1" max="${item.quantity_purchased - item.quantity_sold}" value="1" onchange="updateRow(this)" required></td>
              <td><input type="number" name="rate[]" class="form-control input-sm" min="0" value='${item.mrp}' onchange="updateRow(this)" required></td>
              <td><input type="number" name="subtotal[]" class="form-control input-sm" value="0" readonly></td>
              <td><div class="serial-numbers" style="overflow-y:scroll; max-height:200px;overflow-y: scroll; scrollbar-width: thin; scrollbar-color: #4f6969 #f1f1f1;"></div></td>
              <td>
                <div class="custom-checkbox-wrapper">
                  <input type='checkbox' class='tgl tgl-ios no-sn-checkbox' id='toggle-checkbox_${checkboxId}' onclick="toggleSerialNumbers(this)">
                  <label class='tgl-btn' for='toggle-checkbox_${checkboxId}'></label>
                </div>
              </td>
              <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)"><i class="fa-solid fa-trash-can"></i></button></td>
          `;

          // Store the product ID in a data attribute of the row
          row.dataset.productId = item.id;
          row.dataset.productIndex = selectedProductIndex;

          tableBody.appendChild(row);
          updateRow(row.querySelector('input[name="quantity[]"]'));
        }

        function updateRow(element) {
          const row = element.closest("tr");
          const quantityInput = row.querySelector('input[name="quantity[]"]');
          const maxQuantity = parseInt(quantityInput.getAttribute("max"), 10) || 0; // Get the max allowed quantity
          let quantity = parseInt(quantityInput.value, 10) || 0;

          // Validate and adjust quantity if it exceeds the max allowed
          if (quantity > maxQuantity) {
            quantity = maxQuantity;
            quantityInput.value = maxQuantity; // Set the input value to the max allowed
          }

          const rate = parseFloat(row.querySelector('input[name="rate[]"]').value) || 0;
          const subtotalField = row.querySelector('input[name="subtotal[]"]');
          const serialNumbersContainer = row.querySelector('.serial-numbers');
          let noSnCheckbox = row.querySelector('.no-sn-checkbox');
          noSnCheckbox.readOnly = true;
          let currentProduct = products[row.dataset.productIndex];

          if (currentProduct.product_metadata[0].serial_number === "unmarked") {
            noSnCheckbox.checked = true;
          }

          // Update subtotal
          const subtotal = Math.round(quantity * rate);
          subtotalField.value = subtotal;
          updateTotal();

          if (!noSnCheckbox.checked) {
            const existingSerials = Array.from(serialNumbersContainer.querySelectorAll('input[type="text"]'))
              .map((input) => input.value);

            serialNumbersContainer.innerHTML = '';

            for (let i = 0; i < quantity; i++) {
              const serialWrapper = document.createElement("div");
              serialWrapper.classList.add("input-group");

              const serialInput = document.createElement("input");
              serialInput.type = "text";
              serialInput.required = true;
              serialInput.name = `serialNumber[${quantity - 1}][]`;
              serialInput.placeholder = `Serial ${i + 1}`;
              serialInput.classList.add("form-control", "input-sm", "validate-sn");
              serialInput.value = existingSerials[i] || '';

              // ========== Focus Management Start ==========
              // Handle Enter/Tab key from barcode scanner
              serialInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === 'Tab') {
                  e.preventDefault();
                  const allSerials = serialNumbersContainer.querySelectorAll('input[type="text"]');
                  const currentIndex = Array.from(allSerials).indexOf(this);

                  if (currentIndex < allSerials.length - 1) {
                    allSerials[currentIndex + 1].focus(); // Next serial field
                  } else {
                    // Move to next logical field (rate input)
                    row.querySelector('input[name="rate[]"]').focus();
                  }
                }
              });

              // // Auto-jump when reaching barcode length (adjust 13 to your barcode length)
              // serialInput.addEventListener('input', function (e) {
              //   if (this.value.length === 13) { // Change 13 to your barcode length
              //     const allSerials = serialNumbersContainer.querySelectorAll('input[type="text"]');
              //     const currentIndex = Array.from(allSerials).indexOf(this);

              //     if (currentIndex < allSerials.length - 1) {
              //       allSerials[currentIndex + 1].focus();
              //     } else {
              //       row.querySelector('input[name="rate[]"]').focus();
              //     }
              //   }
              // });
              // ========== Focus Management End ==========

              // Remove button setup
              const removeBtn = document.createElement("button");
              removeBtn.type = "button";
              removeBtn.classList.add("btn", "btn-danger", "btn-sm");
              removeBtn.innerHTML = `<i class="fa-solid fa-xmark"></i>`;
              removeBtn.onclick = () => removeSerialNumber(serialWrapper, row);

              const span = document.createElement("span");
              span.classList.add("input-group-btn");
              span.appendChild(removeBtn);

              serialWrapper.appendChild(serialInput);
              serialWrapper.appendChild(span);
              serialNumbersContainer.appendChild(serialWrapper);
            }

            // Attach validation on blur
            const inputFields = document.querySelectorAll(".validate-sn");
            inputFields.forEach((inputField) => {
              inputField.addEventListener("blur", checkInputValue);
            });
          } else {
            serialNumbersContainer.innerHTML = '';
          }
        }
        // Function to handle validation for each input
        function checkInputValue(event) {
          const inputValue = event.target.value.trim(); // Normalize input
          const row = event.target.closest("tr");
          const product = products[row.dataset.productIndex]; // Get the product for the current row

          // Check if the serial number exists
          const isValid = product.product_metadata.some(item => item.serial_number === inputValue);

          if (inputValue && !isValid) {
            showErrorMessage(`${inputValue} does not exist, Please enter correct S/N`);
            event.target.value = ""; // Clear the input if invalid
          }
        }

        // Function to remove a serial number and update quantity and subtotal
        function removeSerialNumber(serialInput, row) {
          const serialWrapper = serialInput.closest("div");
          serialWrapper.remove();

          // Update quantity and subtotal
          const quantityField = row.querySelector('input[name="quantity[]"]');
          let quantity = parseInt(quantityField.value);
          quantity -= 1;
          if (quantity < 0) quantity = 0;
          quantityField.value = quantity;

          // Recalculate subtotal
          const rate = row.querySelector('input[name="rate[]"]').value;
          const subtotalField = row.querySelector('input[name="subtotal[]"]');
          const subtotal = Math.round(quantity * rate);
          subtotalField.value = subtotal;
          updateTotal();
        }

        document.getElementById("shipment_cost").addEventListener("blur", ev => {
          updateTotal()
        })
        // Function to update the total subtotal in the footer
        function updateTotal() {
          let billAmount = 0, discountAmount = 0, totalAmount = 0;
          document.querySelectorAll('input[name="subtotal[]"]').forEach(subtotalField => {
            billAmount += parseInt(parseFloat(subtotalField.value) || 0); // Convert subtotal to integer
          });
          document.getElementById("bill_amount").value = billAmount;
          discountAmount = parseFloat(document.getElementById("discount").value) || 0;
          let shipmentCost = parseInt(document.getElementById("shipment_cost").value) || 0;
          totalAmount = Math.round(billAmount - billAmount * discountAmount / 100) + shipmentCost;
          document.getElementById("total_amount").value = totalAmount;
          document.getElementById("paid_amount").max = totalAmount;
          document.getElementById("due_amount").value = totalAmount - parseInt(document.getElementById("paid_amount").value) || 0;
        }

        //updating total amount on change discount input
        document.getElementById("discount").addEventListener("change", e => {
          updateTotal()
        })
        //updating discount on change total_amount input
        document.getElementById("total_amount").addEventListener("change", e => {
          let totalAmount = parseInt(document.getElementById("total_amount").value) || 0;
          document.getElementById("paid_amount").max = totalAmount
          document.getElementById("due_amount").value = totalAmount - parseInt(document.getElementById("paid_amount").value) || 0;

          let shipmentCost = parseInt(document.getElementById("shipment_cost").value) || 0;
          totalAmount -= shipmentCost
          let billAmount = parseInt(document.getElementById("bill_amount").value) || 0;
          document.getElementById("discount").value = parseFloat((billAmount - totalAmount) * 100 / billAmount).toFixed(2);

        })
        //updating due amount on change paid_amount input
        document.getElementById("paid_amount").addEventListener("change", e => {
          let totalAmount = parseInt(document.getElementById("total_amount").value) || 0
          let paidAmount = parseInt(document.getElementById("paid_amount").value) || 0
          document.getElementById("due_amount").value = totalAmount - paidAmount;
        })

        // Function to remove a row
        function removeRow(button) {
          const row = button.closest("tr");
          row.remove();
          updateTotal();
        }

        // Function to toggle serial numbers based on "No SN" checkbox
        function toggleSerialNumbers(checkbox) {
          const row = checkbox.closest("tr");
          updateRow(row.querySelector('input[name="quantity[]"]')); // Update row when toggling
        }

        // Function to get all table data including serial numbers
        function getTableData() {
          const tableBody = document.querySelector("#itemTable tbody");
          const rows = tableBody.querySelectorAll("tr");
          const data = [];

          rows.forEach(row => {
            const product_name = row.querySelector('input[name="itemName[]"]').value;
            const warranty = parseInt(row.querySelector('input[name="warranty[]"]').value);
            const quantity = parseInt(row.querySelector('input[name="quantity[]"]').value);
            const rate = parseInt(row.querySelector('input[name="rate[]"]').value);
            const subtotal = parseInt(row.querySelector('input[name="subtotal[]"]').value);
            let serial_numbers = Array.from(row.querySelectorAll('input[name^="serialNumber"]')).map(input => input.value);
            const no_serial_number = row.querySelector('.no-sn-checkbox').checked;

            const parts = product_name.split("#");
            let item = products[parseInt(parts[parts.length - 1])]
            //update product mrp
            item.mrp = rate;
            let serial_numbers_id = []

            //insert serial number for non SN Product
            if (no_serial_number) {
              for (let i = 0; i < quantity; i++) {
                let pm = item.product_metadata[i];
                // serial_numbers.push(pm.serial_number)
                serial_numbers_id.push(pm.id)
              }
            } else {
              serial_numbers.forEach(sn => {
                let pm = item.product_metadata.find(pmx => pmx.serial_number === sn)
                serial_numbers_id.push(pm.id)
              })
            }

            data.push({
              item,
              warranty,
              quantity,
              rate,
              subtotal,
              serial_numbers,
              serial_numbers_id,
            });
          });

          return data;
        }

        //submit form 
        function submitForm() {
          const form = document.getElementById("itemForm")
          // Prevent actual form submission
          if (!form.checkValidity()) {
            alertQuestion("Please fill out the required fields.");
            return;
          }
          //disable submit btn
          document.getElementById("submitBtn").innerHTML = 'Processing &nbsp;<i class="fa fa-spinner fa-spin"></i>';
          document.getElementById("submitBtn").disabled = true;
          const tableData = getTableData();

          //calculate total purchase cost of the selected product
          let totalPurchaseCost = 0
          let description = ''
          tableData.forEach((productItem, i) => {
            totalPurchaseCost += productItem.quantity * (productItem.item.purchase_cost - productItem.item.purchase_discount) / productItem.item.quantity_purchased;
            if (i > 0) {
              description += "|||"
            }
            description += 'SALE: ' + productItem.item.product_name + ' - ' + productItem.quantity + ' @ ' + (productItem.rate * (1 - parseFloat(document.getElementById("discount").value) / 100.0)).toFixed(0)
          })

          const reqBody = {
            sale_date: document.getElementById("sale_date").value,
            customer: selectedCustomer,
            head_account: headAccounts[parseInt(document.getElementById("head_account").value)],
            memo_no: document.getElementById("memo_no").value,
            challan_no: document.getElementById("challan_no").value,
            note: description,
            bill_amount: parseInt(document.getElementById("bill_amount").value),
            discount: parseFloat(document.getElementById("discount").value),
            shipment_cost: parseInt(document.getElementById("shipment_cost").value),
            total_amount: parseInt(document.getElementById("total_amount").value),
            paid_amount: parseInt(document.getElementById("paid_amount").value),
            gross_profit: parseInt(document.getElementById("total_amount").value - totalPurchaseCost),
            due_amount: parseInt(document.getElementById("due_amount").value),
            sold_products: tableData
          }
          console.log("Request Body: ", reqBody); // Log table data to console
          const requestOptions = {
            method: 'post',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + localStorage.getItem('token'),
            },
            body: JSON.stringify(reqBody),
          }
          fetch(api+'/api/v2/inventory/products/sale', requestOptions)
            .then(response => response.json())
            .then(data => {
              console.log("Response: ", data)
              if (data.error === true) {
                showErrorMessage(data.message)
                //disable submit btn
                document.getElementById("submitBtn").innerHTML = 'Complete Sale"></i>';
                document.getElementById("submitBtn").disabled = false;
              } else {
                showSuccessMessage(data.message);
                InvoiceData = data.sales_invoice_data
                company = data.company_profile
                setTimeout(() => {
                  document.getElementById("submitBtn").classList.add('d-none')
                  document.getElementById("printInvoiceBtn").classList.remove('d-none')
                  document.getElementById("printChallanBtn").classList.remove('d-none')
                }, 1000);

              }
            });

        }
        //printSaleInvoice prints the current invoice
        // function printSaleInvoice() {
        //   const newWindow = window.open("", "_blank");
        //   // //product list table
        //   let tBody = ""
        //   let company_info = ""
        //   let name = company.name.split(":::").filter(p => p.trim() !== "")
        //   const companyFName = name[0]
        //   const companyLName = name[1] || ""
        //   let pLn = InvoiceData.sold_products.length
        //   for (let i = 0; i < pLn; i++) {
        //     const items = InvoiceData.sold_products[i]
        //     let serialNumbers = ""

        //     items.serial_numbers.forEach((sn, j) => {
        //       if (sn !== 'unmarked') {
        //         serialNumbers += `S/N:&nbsp;&nbsp;${sn}    `
        //       }
        //     })
        //     tBody += `
        //       <tr class="item-row">
        //         <td>${i + 1}</td>
        //         <td class="item-name">
        //           ${items.item.product_name} <br>
        //           <small> ${serialNumbers} </small>
        //         </td>
        //         <td class="item-warranty text-center">${items.warranty}</td>
        //         <td class="item-quantity text-center">${items.quantity}</td>
        //         <td class="item-price text-right">${items.rate}</td>
        //         <td class="item-total text-right">${items.quantity * items.rate}</td>
        //       </tr>
        //     `
        //   }

        //   tBody += `
        //     <tr class="item-row">
        //       <td rowspan="4" colspan="4" style="border: none; text-align:left; font-weight:bold">
        //         Amount Chargeable (In Words): 
        //         <span style="padding:5px; font-weight:normal; text-transform: capitalize;" id="total-amount-in-words">
        //           ${company.currency === "Taka" ? numberToWordsBDT(InvoiceData.total_amount) : numberToWords(InvoiceData.total_amount) + " " + company.currency} Only.
        //         </span>
        //       </td>
        //       <td class="text-right item-total">Subtotal</td>
        //       <td id="subtotal" class="text-right item-total">${InvoiceData.bill_amount}</td>
        //     </tr>
        //     <tr class="item-row">
        //       <td class="text-right item-total">Shipment Charge</td>
        //       <td id="subtotal" class="text-right item-total">${InvoiceData.shipment_cost}</td>
        //     </tr>
        //     <!-- <tr class="item-row">
        //         <td id="tax-percentage" class="text-right item-total">Tax(%)</td>
        //         <td id="tax-total" class="text-right item-total">10</td>
        //     </tr> -->
        //     <tr class="item-row">
        //         <td id="discount-percentage" class="text-right item-total">Discount(${InvoiceData.discount}%)</td>
        //         <td id="discount-total" class="text-right item-total">${InvoiceData.total_amount - InvoiceData.bill_amount - InvoiceData.shipment_cost}</td>
        //     </tr>
        //     <tr class="item-row">
        //         <td class="text-right total">Total</td>
        //         <td id="total" class="text-right total">${InvoiceData.total_amount}</td>
        //     </tr>
        //   `
        //   //terms and conditions
        //   let terms = "";
        //   const terms_conditions = company.terms_conditions.split("#").filter(term => term.trim() !== "")
        //   terms_conditions.forEach(term => {
        //     terms += `<li>${term}.</li>`
        //   });

        //   //member of associations
        //   let members_of = "";
        //   members_of += `<span>Member of:</span>`
        //   const associations = company.associations_logo_links.split("#").filter(association => association.trim() !== "")
        //   associations.forEach(association => {
        //     members_of += `<img src="${association}" alt="${association}">`
        //   });

        //   const content = `
        //   <!DOCTYPE html>
        //   <html lang="en">
        //   <head>
        //       <meta charset="UTF-8">
        //       <meta name="viewport" content="width=device-width, initial-scale=1.0">
        //       <title>Invoice</title>
        //       <style>
        //           :root {
        //               --primary-color: #6ab023;
        //               --black-color: #000000;
        //               --dark-color: #282b30;
        //               --light-gray: #f2f2f2;
        //               --border-color: #bfbebe;
        //               --white-color: #ffffff;
        //           }

        //           body {
        //               font-family: Arial, Helvetica, sans-serif;
        //               font-weight: normal;
        //               margin: 0;
        //               padding: 10px;
        //               color: var(--black-color);
        //               font-size: 11px;
        //               line-height: 1.3;
        //           }

        //           .container {
        //               max-width: 800px;
        //               margin: 0 auto;
        //           }

        //           .header {
        //               display: flex;
        //               justify-content: space-between;
        //               margin-bottom: 5px;
        //           }

        //           .logo-section {
        //               display: flex;
        //               align-items: center;
        //           }

        //           .logo {
        //               width: 48px;
        //               height: 42px;
        //               margin-right: 0px;
        //           }

        //           .logo img {
        //               width: 100%;
        //               height: 100%;
        //               object-fit: contain;
        //               background-color: var(--white-color);
        //           }

        //           .company-name {
        //               color: var(--primary-color);
        //               font-weight: bold;
        //               font-size: 26px;
        //               line-height: 0.8;
        //               padding-left: 2px;
        //               text-transform: uppercase;
        //           }

        //           .enterprise {
        //               color: var(--black-color);
        //               font-size: 20px;
        //               letter-spacing: 1.5px;
        //           }

        //           .company-address {
        //               font-size: 9px;
        //               max-width: 400px;
        //               margin-top: 4px;
        //               line-height: 1.2;
        //               font-weight: bold;
        //           }

        //           .contact-info {
        //               text-align: right;
        //               font-size: 10px;
        //               font-weight: bold;
        //               font-weight: 500;
        //           }

        //           .contact-info a {
        //               color: var(--primary-color);
        //               text-decoration: none;
        //               font-weight: bold;
        //           }

        //           .invoice-title {
        //               background-color: white;
        //               color: var(--dark-color);
        //               text-align: center;
        //               padding: 3px;
        //               margin: 5px auto;
        //               width: 90px;
        //               font-size: 12px;
        //               font-weight: bold;
        //               border: 1px solid var(--black-color);
        //               border-radius: 2px;
        //               box-shadow: 1px 1px 0px 1px var(--black-color);
        //           }

        //           .dotted-line {
        //               border-top: 1px dotted #999;
        //               margin: 5px 0;
        //           }

        //           .details {
        //               display: flex;
        //               justify-content: space-between;
        //               margin-bottom: 10px;
        //           }

        //           .left-details {
        //               width: 60%;
        //           }

        //           .right-details {
        //               width: 35%;
        //           }

        //           .detail-row {
        //               display: flex;
        //               margin-bottom: 2px;
        //           }

        //           .detail-label {
        //               width: 80px;
        //               font-weight: bold;
        //               font-size: 11px;
        //           }

        //           .detail-value {
        //               flex: 1;
        //               font-size: 11px;
        //           }

        //           table {
        //               width: 100%;
        //               border-collapse: collapse;
        //           }

        //           th {
        //               background-color: var(--light-gray);
        //               color: var(--black-color);
        //               text-transform: capitalize;
        //               font-weight: bolder;
        //               text-align: center;
        //               padding: 5px 5px;
        //               font-size: 10px;
        //               border: 1px solid var(--dark-color);
        //           }

        //           td {
        //               padding: 1px 5px;
        //               font-size: 10px;
        //               color: var(--black-color);
        //               font-weight: 500;
        //               border: 1px solid var(--dark-color);
        //               border-top: none;
        //           }

        //           .item-row .item-name {
        //               font-size: 10px;
        //               font-weight: 600;
        //               color: var(--black-color);
        //               max-width: 45% !important;
        //           }

        //           .item-row .item-name small {
        //             font-size: 9px;
        //             font-weight: 400;
        //             color: var(--black-color);
        //             white-space: normal;
        //             word-break: break-word;
        //             overflow-wrap: anywhere;
        //         }

        //           .empty-row td {
        //               padding: 4px 8px;
        //               border-bottom: 1px solid var(--border-color);
        //           }

        //           .item-total {
        //               padding: 3px 5px;
        //           }

        //           .total {
        //               background-color: var(--light-gray);
        //               font-weight: bold;
        //               padding: 3px 5px;
        //           }

        //           .text-right {
        //               text-align: right;
        //           }

        //           .text-center {
        //               text-align: center;
        //           }

        //           /* Payment info section */
        //           .payment-section {
        //               font-size: 9px;
        //               margin: 10px 0;
        //           }

        //           .payment-section h4 {
        //               margin-bottom: 3px;
        //               margin-top: 0;
        //               font-size: 10px;
        //               text-decoration: underline;
        //           }

        //           .payment-section .detail-label,
        //           .payment-section .detail-value {
        //               font-size: 9px;
        //           }

        //           .terms {
        //               font-size: 9px;
        //               margin: 10px 0;
        //           }

        //           .terms h4 {
        //               margin-bottom: 3px;
        //               margin-top: 0;
        //               font-size: 10px;
        //               text-decoration: underline;
        //           }

        //           .terms ul {
        //               margin: 0;
        //               padding-left: 15px;
        //               line-height: 1.2;
        //           }

        //           .terms ul ul {
        //               padding-left: 10px;
        //           }

        //           .terms li {
        //               margin-bottom: 1px;
        //           }


        //           .invoice-footer-fixed {
        //               position: absolute;
        //               bottom: 0;
        //               left: 50%;
        //               transform: translate(-50%);
        //               width: 100%;
        //               max-width: 800px;
        //               padding: 10px;
        //               box-sizing: border-box;
        //               background: #fff;
        //               break-inside: avoid;
        //           }

        //           .invoice-footer-scroll {
        //               width: 100%;
        //               max-width: 800px;
        //               padding: 40px;
        //               box-sizing: border-box;
        //               background: #fff;
        //               break-inside: avoid;
        //           }

        //           .signature-section {
        //               display: flex;
        //               justify-content: space-around;
        //               padding-bottom: 8px;
        //               margin-bottom: 8px;
        //           }

        //           .signature-box {
        //               width: 180px;
        //               text-align: center;
        //               border-top: 1px solid #000;
        //               padding-top: 3px;
        //               font-size: 10px;
        //           }

        //           .remark {
        //               font-size: 8px;
        //               margin-top: 2px;
        //           }

        //           .invoice-footer-info {
        //               display: flex;
        //               justify-content: space-between;
        //               align-items: center;
        //               font-size: 9px;
        //           }

        //           .member-logos {
        //               display: flex;
        //               align-items: center;
        //               font-weight:bold;
        //               gap: 6px;
        //           }

        //           .member-logos img {
        //               height: 24px;
        //           }

        //           .print-info {
        //               text-align: right;
        //               font-weight: 500;
        //           }

        //           .footer-remark{
        //               font-size: 8px;
        //               text-align:center;
        //               color: rgb(0, 94, 255);
        //           }

        //           .watermark-container {
        //               position: fixed;
        //               top: 50%;
        //               left: 50%;
        //               transform: translate(-50%, -50%);
        //               z-index: 0;
        //               pointer-events: none;
        //               /* Allow clicks through the watermark */
        //           }

        //           .watermark {
        //               opacity: 0.1;
        //               width: 400px;
        //               /* adjust as needed */
        //               height: auto;
        //           }
        //       </style>
        //   </head>

        //   <body>
            
        //     ${company.watermark === "" ? "" :
        //       `<div class="watermark-container">
        //         <img src="${company.watermark}" alt="Watermark" class="watermark">
        //       </div>`
        //     }
        //       <div class="container">
        //         <div id="invoice-content">
        //             <div class="header">
        //                 <div>
        //                     <div class="logo-section">
        //                          ${company.logo_link === "" ? "" :
        //                           `<div class="logo">
        //                               <img src="${company.logo_link}" alt="">
        //                           </div>`}
        //                         <div>
        //                             <div class="company-name">
        //                               ${companyFName}
        //                               ${companyLName === "" ? "" : `<br>
        //                               <span class="enterprise">${companyLName}</span>`}
        //                             </div>
        //                         </div>
        //                     </div>
        //                     <div class="company-address">
        //                         ${company.area} <br>
        //                        ${company.mobile === "" ? "" : ' Hotline: ' + company.mobile}
        //                     </div>
        //                 </div>
        //                 <div class="contact-info">
        //                     ${company.website === "" ? "" : `<a href="${company.website}">${company.website}</a>`} <br>
        //                     ${company.email === "" ? "" : `<a href="mailto:${company.email}">${company.email}</a>`}
        //                 </div>
        //             </div>

        //             <div class="dotted-line"></div>
        //             <div class="invoice-title">Invoice/Bill</div>

        //             <div class="details">
        //                 <div class="left-details">
        //                     <div class="detail-row">
        //                         <div class="detail-label">Invoice To</div>
        //                         <div class="detail-value">: ${InvoiceData.customer.account_name.toUpperCase()}</div>
        //                     </div>
        //                     <div class="detail-row">
        //                         <div class="detail-label">Address</div>
        //                         <div class="detail-value">: ${InvoiceData.customer.area === "" ? "-" : InvoiceData.customer.area}</div>
        //                     </div>
        //                     <div class="detail-row">
        //                         <div class="detail-label">Mobile</div>
        //                         <div class="detail-value">: ${InvoiceData.customer.mobile}</div>
        //                     </div>
        //                 </div>
        //                 <div class="right-details">
        //                     <div class="detail-row">
        //                         <div class="detail-label">Invoice No.</div>
        //                         <div class="detail-value">: ${InvoiceData.memo_no}</div>
        //                     </div>
        //                     <div class="detail-row">
        //                         <div class="detail-label">Date & Time</div>
        //                         <div class="detail-value">: ${moment(InvoiceData.sale_date).format("DD-MMMM-YYYY")}</div>
        //                     </div>
        //                     <div class="detail-row">
        //                         <div class="detail-label">Prepared By</div>
        //                         <div class="detail-value">: ${appUser.username}</div>
        //                     </div>
        //                 </div>
        //             </div>

        //             <table id="invoice-items">
        //                 <thead>
        //                     <tr>
        //                         <th style="width: 5%;">No</th>
        //                         <th style="width: 45%;max-width: 45%;">Item Description</th>
        //                         <th style="width: 12%;">Warranty</th>
        //                         <th style="width: 10%;">Qty</th>
        //                         <th style="width: 13%;">Price</th>
        //                         <th style="width: 15%;">Total</th>
        //                     </tr>
        //                 </thead>
        //                 <tbody id="product-items">
        //                     <!-- will be updated by JS -->
        //                     ${tBody}
        //                 </tbody>
        //             </table>
        //             <div class="payment-section">
        //                 <h4>Payment Information</h4>
        //                 <div class="details">
        //                     <div class="left-details">
        //                         <div class="detail-row">
        //                             <div class="detail-label">Payment Method</div>
        //                             <div class="detail-value">: ${InvoiceData.challan_no === "" ? "Cash Received" : "Bank Payment"}</div>
        //                         </div>
        //                         <div class="detail-row">
        //                             <div class="detail-label">Payment Type</div>
        //                             <div class="detail-value">: ${InvoiceData.total_amount - InvoiceData.paid_amount > 0 ? "Partial Payment" : "Full Payment"}  ${!InvoiceData.Note || InvoiceData.Note === "" ? "" : `<b> (${InvoiceData.Note})</b>`}</div>
        //                         </div>
        //                         ${InvoiceData.challan_no && InvoiceData.challan_no !== "" ? `<div class="detail-row">
        //                             <div class="detail-label">Cheque No.</div>
        //                             <div class="detail-value">: ${InvoiceData.challan_no} </div>
        //                         </div>`  : ""}
                                
        //                         <div class="detail-row">
        //                             <div class="detail-label">Paid Amount</div>
        //                             <div class="detail-value">: ${InvoiceData.paid_amount} <b>(In Words: ${company.currency === "Taka" ? numberToWordsBDT(InvoiceData.paid_amount) : numberToWords(InvoiceData.paid_amount) + " " + company.currency} Only)</b></div>
        //                         </div>
        //                         <div class="detail-row">
        //                             <div class="detail-label">Note</div>
        //                             <div class="detail-value">: ${!InvoiceData.Note || InvoiceData.Note === "" ? "" : `<b> (${InvoiceData.Note})</b>`}</div>
        //                         </div>
        //                     </div>
        //                 </div>
        //             </div>
        //             <div class="dotted-line"></div>
        //             <div class="terms">
        //                 <h4>Terms & Condition</h4>
        //                 <ul>
        //                   ${terms}
        //                 </ul>
        //             </div>
        //         </div>

        //         <div class="invoice-footer-fixed" id="invoice-footer">
        //             <div class="signature-section">
        //                 <div class="signature-box">
        //                     Customer Signature
        //                     <div class="remark">(Received the above goods in good condition)</div>
        //                 </div>
        //                 <div class="signature-box">
        //                     Authorized Signature
        //                 </div>
        //             </div>
        //             <div class="dotted-line"></div>
        //             <div class="invoice-footer-info">
        //               <div class="member-logos">
        //                 ${members_of === "" ? "" : `<span>Member of:</span>${members_of}`}
        //               </div>
        //                 <div class="print-info">
        //                     <div class="print-date">
        //                         Print Date &amp; Time : <span id="currentDateTime">${moment().format("DD-MMMM-YYYY hh:mm:ssA")}</span>
        //                     </div>
        //                 </div>
        //             </div>
        //         </div>
        //       </div>
        //   </body>
        //   </html>
        //   `

        //   // Write content to the new window
        //   newWindow.document.write(content);
        //   newWindow.document.close();
        //   // Add a slight delay before printing to ensure content is fully loaded
        //   setTimeout(() => {
        //     const invoiceContentDiv = newWindow.document.getElementById('invoice-content');
        //     const invoiceFooterDiv = newWindow.document.getElementById('invoice-footer');
        //     if (!invoiceContentDiv || !invoiceFooterDiv) return;

        //     const rect1 = invoiceContentDiv.getBoundingClientRect();
        //     const rect2 = invoiceFooterDiv.getBoundingClientRect();

        //     // Check if elements overlap
        //     const noOverlap =
        //       rect1.right < rect2.left ||
        //       rect1.left > rect2.right ||
        //       rect1.bottom < rect2.top ||
        //       rect1.top > rect2.bottom;

        //     if (!noOverlap) {
        //       invoiceFooterDiv.classList.remove('invoice-footer-fixed');
        //       invoiceFooterDiv.classList.add('invoice-footer-scroll');
        //     }
        //     newWindow.print();
        //   }, 500);

        // }

        //printSaleChallan prints the current challan
        function printSaleChallan() {
          const newWindow = window.open("", "_blank");
          // //product list table
          let tBody = ""
          let company_info = ""
          let name = company.name.split(":::").filter(p => p.trim() !== "")
          const companyFName = name[0]
          const companyLName = name[1] || ""
          let pLn = InvoiceData.sold_products.length
          for (let i = 0; i < pLn; i++) {
            const items = InvoiceData.sold_products[i]
            let serialNumbers = ""

            items.serial_numbers.forEach((sn, j) => {
              if (sn !== 'unmarked') {
                serialNumbers += `S/N:&nbsp;&nbsp;${sn}`
              }
            })
            tBody += `
              <tr class="item-row">
                <td>${i + 1}</td>
                <td class="item-name">
                  ${items.item.product_name} <br>
                  <small> ${serialNumbers} </small>
                </td>
                <td class="item-quantity text-center">${items.quantity}</td>
              </tr>
            `
          }

          //member of associations
          let members_of = "";
          members_of += `<span>Member of:</span>`
          const associations = company.associations_logo_links.split("#").filter(association => association.trim() !== "")
          associations.forEach(association => {
            members_of += `<img src="${association}" alt="${association}">`
          });

          const content = `
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Invoice</title>
              <style>
                  :root {
                      --primary-color: #6ab023;
                      --black-color: #000000;
                      --dark-color: #282b30;
                      --light-gray: #f2f2f2;
                      --border-color: #bfbebe;
                      --white-color: #ffffff;
                  }

                  body {
                      font-family: Arial, Helvetica, sans-serif;
                      font-weight: normal;
                      margin: 0;
                      padding: 10px;
                      color: var(--black-color);
                      font-size: 11px;
                      line-height: 1.3;
                  }

                  .container {
                      max-width: 800px;
                      margin: 0 auto;
                  }

                  .header {
                      display: flex;
                      justify-content: space-between;
                      margin-bottom: 5px;
                  }

                  .logo-section {
                      display: flex;
                      align-items: center;
                  }

                  .logo {
                      width: 48px;
                      height: 42px;
                      margin-right: 0px;
                  }

                  .logo img {
                      width: 100%;
                      height: 100%;
                      object-fit: contain;
                      background-color: var(--white-color);
                  }

                  .company-name {
                      color: var(--primary-color);
                      font-weight: bold;
                      font-size: 26px;
                      line-height: 0.8;
                      padding-left: 2px;
                      text-transform: uppercase;
                  }

                  .enterprise {
                      color: var(--black-color);
                      font-size: 20px;
                      letter-spacing: 1.5px;
                  }

                  .company-address {
                      font-size: 9px;
                      max-width: 400px;
                      margin-top: 4px;
                      line-height: 1.2;
                      font-weight: bold;
                  }

                  .contact-info {
                      text-align: right;
                      font-size: 10px;
                      font-weight: bold;
                      font-weight: 500;
                  }

                  .contact-info a {
                      color: var(--primary-color);
                      text-decoration: none;
                      font-weight: bold;
                  }

                  .invoice-title {
                      background-color: white;
                      color: var(--dark-color);
                      text-align: center;
                      padding: 3px;
                      margin: 5px auto;
                      width: 90px;
                      font-size: 12px;
                      font-weight: bold;
                      border: 1px solid var(--black-color);
                      border-radius: 2px;
                      box-shadow: 1px 1px 0px 1px var(--black-color);
                  }

                  .dotted-line {
                      border-top: 1px dotted #999;
                      margin: 5px 0;
                  }

                  .details {
                      display: flex;
                      justify-content: space-between;
                      margin-bottom: 10px;
                  }

                  .left-details {
                      width: 60%;
                  }

                  .right-details {
                      width: 35%;
                  }

                  .detail-row {
                      display: flex;
                      margin-bottom: 2px;
                  }

                  .detail-label {
                      width: 80px;
                      font-weight: bold;
                      font-size: 11px;
                  }

                  .detail-value {
                      flex: 1;
                      font-size: 11px;
                  }

                  table {
                      width: 100%;
                      border-collapse: collapse;
                  }

                  th {
                      background-color: var(--light-gray);
                      color: var(--black-color);
                      text-transform: capitalize;
                      font-weight: bolder;
                      text-align: center;
                      padding: 5px 5px;
                      font-size: 10px;
                      border: 1px solid var(--dark-color);
                  }

                  td {
                      padding: 1px 5px;
                      font-size: 10px;
                      color: var(--black-color);
                      font-weight: 500;
                      border: 1px solid var(--dark-color);
                      border-top: none;
                  }

                  .item-row .item-name {
                      font-size: 10px;
                      font-weight: 600;
                      color: var(--black-color);
                      max-width: 45% !important;
                  }

                  .item-row .item-name small {
                    font-size: 9px;
                    font-weight: 400;
                    color: var(--black-color);
                    white-space: normal;
                    word-break: break-word;
                    overflow-wrap: anywhere;
                }

                  .empty-row td {
                      padding: 4px 8px;
                      border-bottom: 1px solid var(--border-color);
                  }

                  .item-total {
                      padding: 3px 5px;
                  }

                  .total {
                      background-color: var(--light-gray);
                      font-weight: bold;
                      padding: 3px 5px;
                  }

                  .text-right {
                      text-align: right;
                  }

                  .text-center {
                      text-align: center;
                  }

                  /* Payment info section */
                  .payment-section {
                      font-size: 9px;
                      margin: 10px 0;
                  }

                  .payment-section h4 {
                      margin-bottom: 3px;
                      margin-top: 0;
                      font-size: 10px;
                      text-decoration: underline;
                  }

                  .payment-section .detail-label,
                  .payment-section .detail-value {
                      font-size: 9px;
                  }

                  .terms {
                      font-size: 9px;
                      margin: 10px 0;
                  }

                  .terms h4 {
                      margin-bottom: 3px;
                      margin-top: 0;
                      font-size: 10px;
                      text-decoration: underline;
                  }

                  .terms ul {
                      margin: 0;
                      padding-left: 15px;
                      line-height: 1.2;
                  }

                  .terms ul ul {
                      padding-left: 10px;
                  }

                  .terms li {
                      margin-bottom: 1px;
                  }


                  .invoice-footer-fixed {
                      position: absolute;
                      bottom: 0;
                      left: 50%;
                      transform: translate(-50%);
                      width: 100%;
                      max-width: 800px;
                      padding: 10px;
                      box-sizing: border-box;
                      background: #fff;
                      break-inside: avoid;
                  }

                  .invoice-footer-scroll {
                      width: 100%;
                      max-width: 800px;
                      padding: 40px;
                      box-sizing: border-box;
                      background: #fff;
                      break-inside: avoid;
                  }

                  .signature-section {
                      display: flex;
                      justify-content: space-around;
                      padding-bottom: 8px;
                      margin-bottom: 8px;
                  }

                  .signature-box {
                      width: 180px;
                      text-align: center;
                      border-top: 1px solid #000;
                      padding-top: 3px;
                      font-size: 10px;
                  }

                  .remark {
                      font-size: 8px;
                      margin-top: 2px;
                  }

                  .invoice-footer-info {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      font-size: 9px;
                  }

                  .member-logos {
                      display: flex;
                      align-items: center;
                      font-weight:bold;
                      gap: 6px;
                  }

                  .member-logos img {
                      height: 24px;
                  }

                  .print-info {
                      text-align: right;
                      font-weight: 500;
                  }

                  .footer-remark{
                      font-size: 8px;
                      text-align:center;
                      color: rgb(0, 94, 255);
                  }

                  .watermark-container {
                      position: fixed;
                      top: 50%;
                      left: 50%;
                      transform: translate(-50%, -50%);
                      z-index: 0;
                      pointer-events: none;
                      /* Allow clicks through the watermark */
                  }

                  .watermark {
                      opacity: 0.1;
                      width: 400px;
                      /* adjust as needed */
                      height: auto;
                  }
              </style>
          </head>

          <body>
            
            ${company.watermark && company.watermark != "" ?
              `<div class="watermark-container">
                <img src="${company.watermark}" alt="Watermark" class="watermark">
              </div>` : ""
            }
              <div class="container">
                <div id="invoice-content">
                    <div class="header">
                        <div>
                            <div class="logo-section">
                                 ${company.logo_link === "" ? "" :
                                  `<div class="logo">
                                      <img src="${company.logo_link}" alt="">
                                  </div>`}
                                <div>
                                    <div class="company-name">
                                      ${companyFName}
                                      ${companyLName === "" ? "" : `<br>
                                      <span class="enterprise">${companyLName}</span>`}
                                    </div>
                                </div>
                            </div>
                            <div class="company-address">
                                ${company.area} <br>
                               ${company.mobile === "" ? "" : ' Hotline: ' + company.mobile}
                            </div>
                        </div>
                        <div class="contact-info">
                            ${company.website === "" ? "" : `<a href="${company.website}">${company.website}</a>`} <br>
                            ${company.email === "" ? "" : `<a href="mailto:${company.email}">${company.email}</a>`}
                        </div>
                    </div>

                    <div class="dotted-line"></div>
                    <div class="invoice-title">Invoice/Bill</div>

                    <div class="details">
                        <div class="left-details">
                            <div class="detail-row">
                                <div class="detail-label">Invoice To</div>
                                <div class="detail-value">: ${InvoiceData.customer.account_name.toUpperCase()}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Address</div>
                                <div class="detail-value">: ${InvoiceData.customer.area === "" ? "-" : InvoiceData.customer.area}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Mobile</div>
                                <div class="detail-value">: ${InvoiceData.customer.mobile}</div>
                            </div>
                        </div>
                        <div class="right-details">
                            <div class="detail-row">
                                <div class="detail-label">Invoice No.</div>
                                <div class="detail-value">: ${InvoiceData.memo_no}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Date & Time</div>
                                <div class="detail-value">: ${moment(InvoiceData.sale_date).format("DD-MMMM-YYYY")}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Prepared By</div>
                                <div class="detail-value">: ${appUser.username || "-"}</div>
                            </div>
                        </div>
                    </div>

                    <table id="invoice-items">
                        <thead>
                            <tr>
                                <th style="width: 5%;">No</th>
                                <th style="width: 45%;max-width: 45%;">Item Description</th>
                                <th style="width: 10%;">Qty</th>
                            </tr>
                        </thead>
                        <tbody id="product-items">
                            <!-- will be updated by JS -->
                            ${tBody}
                        </tbody>
                    </table>
                    <div class="dotted-line"></div>
                    <div class="terms">
                        <h4>Remarks:</h4>
                        <ul>
                          This challan is generated electronically. The company reserves the right to make changes in case of any inconsistencies or mistakes.
                        </ul>
                    </div>
                </div>

                <div class="invoice-footer-fixed" id="invoice-footer">
                    <div class="signature-section">
                        <div class="signature-box">
                            Customer Signature
                            <div class="remark">(Received the above goods in good condition)</div>
                        </div>
                        <div class="signature-box">
                            Authorized Signature
                        </div>
                    </div>
                    <div class="dotted-line"></div>
                    <div class="invoice-footer-info">
                      <div class="member-logos">
                        ${members_of === "" ? "" : `<span>Member of:</span>${members_of}`}
                      </div>
                        <div class="print-info">
                            <div class="print-date">
                                Print Date &amp; Time : <span id="currentDateTime">${moment().format("DD-MMMM-YYYY hh:mm:ssA")}</span>
                            </div>
                        </div>
                    </div>
                </div>
              </div>
          </body>
          </html>
          `

          // Write content to the new window
          newWindow.document.write(content);
          newWindow.document.close();
          // Add a slight delay before printing to ensure content is fully loaded
          setTimeout(() => {
            const invoiceContentDiv = newWindow.document.getElementById('invoice-content');
            const invoiceFooterDiv = newWindow.document.getElementById('invoice-footer');
            if (!invoiceContentDiv || !invoiceFooterDiv) return;

            const rect1 = invoiceContentDiv.getBoundingClientRect();
            const rect2 = invoiceFooterDiv.getBoundingClientRect();

            // Check if elements overlap
            const noOverlap =
              rect1.right < rect2.left ||
              rect1.left > rect2.right ||
              rect1.bottom < rect2.top ||
              rect1.top > rect2.bottom;

            if (!noOverlap) {
              invoiceFooterDiv.classList.remove('invoice-footer-fixed');
              invoiceFooterDiv.classList.add('invoice-footer-scroll');
            }
            newWindow.print();
          }, 500);

        }

      </script>
</body>

</html>